<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<title>BookBil J√¶ren</title>

<!-- Manifest -->
<link rel="manifest" href="manifest.json">
<!-- Oppdatert ikon (Car Rental) -->
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/7840/7840958.png">
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/7840/7840958.png">

<!-- Biblioteker -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* Base */
.hidden{display:none!important}
body {
    font-family: 'Inter', sans-serif;
    background-color: #0f172a; /* Slate 900 */
    color: #cbd5e1; /* Slate 300 */
    -webkit-font-smoothing: antialiased;
    -webkit-tap-highlight-color: transparent;
    overscroll-behavior-y: contain;
    height: 100vh;
    overflow: hidden; 
}

/* --- UI LARGE MODE OVERRIDES --- */
body.ui-large { font-size: 17px; }
.ui-large .fleet-row { padding: 20px 16px; } 
.ui-large .fleet-row h2 { font-size: 20px; } 
.ui-large .btn-action { padding: 12px 20px; font-size: 13px; }
.ui-large input, .ui-large select { height: 54px !important; font-size: 16px !important; }
.ui-large .material-icons-round { transform: scale(1.2); } 
.ui-large .time-label { font-size: 11px; } 

/* Fleet Row (Liste-element) */
.fleet-row {
    background-color: #1e293b; /* Slate 800 */
    border-bottom: 1px solid #334155; /* Slate 700 */
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: background-color 0.2s;
    cursor: pointer;
    position: relative;
    z-index: 1;
}
.fleet-row:first-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
.fleet-row:last-child { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; border-bottom: none; }
.fleet-row:active { background-color: #334155; }

/* Status Indicators */
.status-stripe {
    width: 4px;
    height: 40px;
    border-radius: 2px;
    margin-right: 12px;
    flex-shrink: 0;
}
.c-green { background-color: #10b981; } /* Ledig > 4t */
.c-yellow { background-color: #f59e0b; } /* Ledig 2-4t */
.c-orange { background-color: #f97316; } /* Ledig < 2t */
.c-red { background-color: #ef4444; }   /* Opptatt */
.c-blue { background-color: #3b82f6; }  /* Min bil */
.c-purple { background-color: #a855f7; } /* Verksted/EU */
.c-gray { background-color: #64748b; }   /* Ute av drift */

/* Knapper i liste */
.btn-action {
    font-size: 11px;
    font-weight: 700;
    padding: 8px 16px;
    border-radius: 6px;
    background-color: #334155; /* Slate 700 */
    color: white;
    border: 1px solid #475569;
    transition: all 0.2s;
    white-space: nowrap;
    position: relative;
    z-index: 5; /* Ensure clickable */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}
.btn-primary { background-color: #3b82f6; border-color: #2563eb; box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3); }
.btn-green { background-color: #059669; border-color: #047857; box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3); }
.btn-amber { background-color: #d97706; border-color: #b45309; box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3); }

/* Updated Box Tabs (Fixed: Proportional Widths) */
.seg-tab-container { 
    background-color: transparent; 
    padding: 4px; 
    display: flex; 
    gap: 8px; 
    width: 100%;
}
.seg-tab { 
    flex: 1 1 auto; /* Allow grow/shrink based on content */
    text-align: center; 
    padding: 8px 4px; 
    font-size: 11px; 
    font-weight: 700; 
    color: #94a3b8; 
    border-radius: 8px; 
    transition: all 0.2s; 
    border: 1px solid #334155;
    background-color: #1e293b;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0; /* Important for flex items to shrink properly */
}
.seg-tab.active { 
    background-color: #3b82f6; 
    color: white; 
    border-color: #2563eb;
    box-shadow: 0 2px 5px rgba(59, 130, 246, 0.4); 
}

/* Bottom Nav */
.bottom-nav { background: #0f172a; border-top: 1px solid #1e293b; height: 80px; padding-bottom: env(safe-area-inset-bottom); }
.big-fab { width: 64px; height: 64px; background: #2563eb; border-radius: 999px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); border: 4px solid #0f172a; transition: transform 0.1s; }
.big-fab:active { transform: scale(0.95); }

/* Menyer */
#more-menu { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
#more-menu.open { transform: translateY(0); }
#menu-bg { transition: opacity 0.3s; pointer-events: none; opacity: 0; background: rgba(0,0,0,0.8); }
#menu-bg.open { pointer-events: auto; opacity: 1; }

/* Input Styles */
input, select, textarea { background-color: #1e293b !important; border-color: #334155 !important; color: white !important; border-radius: 8px !important; }

/* Range Slider (Compact) */
input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; height: 40px; position: relative; z-index: 20; touch-action: none; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 44px; width: 44px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -14px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 4px solid #fff; transition: transform 0.1s; }
input[type=range]:active::-webkit-slider-thumb { transform: scale(1.1); background: #2563eb; }
input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 16px; cursor: pointer; background: #0f172a; border-radius: 99px; border: 1px solid #334155; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }

/* Modal */
.modal-bottom { display: flex; flex-direction: column; justify-content: flex-end; z-index: 100; pointer-events: auto;}
.modal-content-bottom { background-color: #0f172a; border-top: 1px solid #1e293b; border-radius: 20px 20px 0 0; width: 100%; max-height: 90vh; animation: slideUp 0.25s ease-out; overflow-y: auto; padding-bottom: 40px; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.bar{width:40px;height:5px;background:#4b5563;border-radius:99px}

/* Tidslinje */
.timeline-scroll { overflow-x: auto; padding-bottom: 25px; padding-top: 10px; display: flex; margin-bottom: 5px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
.timeline-scroll::-webkit-scrollbar { display: none; }
.time-grid { display: inline-flex; gap: 2px; height: 50px; padding: 0 4px; position: relative; }
.time-block { width: 42px; height: 100%; background-color: #1e293b; border-radius: 6px; position: relative; flex-shrink: 0; cursor: pointer; border: 1px solid #334155; display: flex; justify-content: center; align-items: center; }
.time-label { position: absolute; bottom: -24px; left: 0; width: 100%; text-align: center; font-size: 11px; color: #94a3b8; font-weight: 800; pointer-events: none; opacity: 0.8; }
.time-block.past { opacity: 0.3; background-color: #111; border-color: transparent; pointer-events: none; }
.time-block.busy { background-color: #451a1a; border-color: #7f1d1d; opacity: 0.9; pointer-events: none; background-image: repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(255,255,255,0.05) 3px, rgba(255,255,255,0.05) 6px); }
.time-block.start { background-color: #2563eb; border-color: #60a5fa; z-index: 10; transform: scale(1.1); }
.time-block.end { background-color: #10b981; border-color: #34d399; z-index: 10; transform: scale(1.1); }
.time-block.range { background-color: #1e40af; border-color: #3b82f6; opacity: 0.8; }
.time-now-line { position: absolute; width: 2px; height: 100%; background: #ef4444; z-index: 20; pointer-events: none; box-shadow: 0 0 5px red; }
.time-block.start::after { content: 'A'; color: white; font-weight: 900; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
.time-block.end::after { content: 'B'; color: white; font-weight: 900; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

/* Legend & Misc */
.legend-box { display: flex; gap: 8px; background: #1e293b; border: 1px solid #334155; padding: 4px 10px; border-radius: 999px; font-size: 9px; color: #94a3b8; align-items: center; margin-right: auto; }
.dot { width: 6px; height: 6px; border-radius: 50%; }
.dot.free { background-color: #334155; border: 1px solid #475569; }
.dot.busy { background-color: #7f1d1d; }
.dot.selected { background-color: #2563eb; }
.car-pill { transition: all 0.2s; border: 2px solid transparent; color: white; opacity: 0.7; }
.car-pill.selected { opacity: 1; border-color: white; transform: scale(1.05); }
.pill-green { background-color: #064e3b; border-color: #059669; }
.pill-yellow { background-color: #78350f; border-color: #d97706; }
.pill-gray { background-color: #1f2937; border-color: #4b5563; }
.email-pill { background: #334155; border: 1px solid #475569; color: white; padding: 4px 10px; border-radius: 999px; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; }
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }

/* Settings Cards */
.settings-card { background-color: #1e293b; border: 1px solid #334155; border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
.settings-header { font-size: 14px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
</style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

<div id="offline-msg" class="hidden fixed top-0 w-full bg-red-600 text-white text-xs font-bold text-center py-1 z-[100]">INGEN INTERNETTFORBINDELSE</div>
<div id="toast-container"></div>

<!-- AUTENTISERING -->
<div id="auth" class="flex flex-col items-center justify-center h-screen p-6 text-center fixed inset-0 z-[60] bg-[#0f172a]">
 <span class="material-icons-round text-blue-500 text-7xl mb-4">local_police</span>
 <h1 class="text-3xl font-black mb-1 uppercase text-white">BookBil J√¶ren</h1>
 <p class="text-slate-500 text-sm mb-6">Logg inn med din BID@politiet.no</p>
 <div id="f-email" class="w-full max-w-xs space-y-4">
   <input type="email" id="l-email" placeholder="bid@politiet.no" class="w-full p-4 rounded-xl text-center text-lg font-bold">
   <button onclick="sendOtp()" id="btn-send" class="w-full bg-blue-600 p-4 rounded-xl font-bold text-lg text-white shadow-lg active:scale-95">SEND KODE</button>
 </div>
 <div id="f-otp" class="w-full max-w-xs space-y-4 hidden">
   <input type="text" id="l-otp" placeholder="12345678" maxlength="8" class="w-full p-4 rounded-xl text-center text-2xl font-black tracking-widest">
   <button onclick="verifyOtp()" class="w-full bg-green-600 text-white p-4 rounded-xl font-bold">LOGG INN</button>
   <button onclick="resetAuth()" class="text-slate-500 text-sm underline mt-4">Angre</button>
 </div>
 <button onclick="window.open('https://bbmanual.pages.dev/')" class="text-blue-500 font-bold text-sm mt-6 flex items-center justify-center gap-2"><span class="material-icons-round">auto_stories</span> Brukermanual</button>
</div>

<!-- HOVEDAPP -->
<div id="app" class="hidden h-full flex flex-col relative w-full">
 
 <!-- DASHBOARD HEADER -->
 <header class="flex-none pt-6 pb-2 px-4 bg-[#0f172a] z-30 border-b border-slate-800 shadow-sm">
    <div class="flex justify-between items-end mb-4">
        <div>
            <div class="flex items-center gap-2">
                <h1 id="pg-t" class="text-xl font-bold text-white">BookBil J√¶ren</h1>
                <button id="install-icon" onclick="installPwa()" class="hidden text-blue-400 bg-blue-900/30 p-1 rounded-full hover:bg-blue-900/50 transition-colors">
                    <span class="material-icons-round text-sm">download</span>
                </button>
            </div>
            <p id="u-disp" class="text-xs text-slate-500 font-medium">Laster bruker...</p>
        </div>
        <!-- Quick Stats Container (Hidden on subpages) -->
        <div id="head-stats" class="flex gap-3">
            <div class="text-right">
                <span id="stat-free" class="block text-2xl font-bold text-emerald-400 leading-none">-</span>
                <span class="text-[9px] text-slate-500 uppercase font-bold tracking-wider">Ledig</span>
            </div>
            <div class="w-px h-8 bg-slate-800"></div>
            <div class="text-right">
                <span id="stat-total" class="block text-2xl font-bold text-slate-200 leading-none">-</span>
                <span class="text-[9px] text-slate-500 uppercase font-bold tracking-wider">Totalt</span>
            </div>
        </div>
    </div>

    <!-- Segmented Control Tabs (Updated 1 of 3 UI - Size to text) -->
    <div id="head-tabs" class="seg-tab-container pb-1">
        <button id="tab-ov" onclick="tab('cars')" class="seg-tab active">OVERSIKT</button>
        <button id="tab-res" onclick="tab('res')" class="seg-tab">RESERVASJONER</button>
        <button id="tab-mine" onclick="tab('mine')" class="seg-tab">MINE</button>
    </div>
 </header>

 <!-- PULL TO REFRESH INDIKATOR -->
 <div id="ptr" class="w-full text-center py-2 -mt-10 transition-all duration-300 absolute z-20 pointer-events-none"><span id="ptr-icon" class="material-icons-round text-slate-500">arrow_downward</span></div>
 
 <!-- MAIN CONTENT LIST -->
 <main id="main" class="flex-1 overflow-y-auto px-4 pb-32 pt-4 w-full" 
       ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event)">
    <div class="text-center mt-20 text-slate-500">Laster...</div>
 </main>
 
 <!-- BOTTOM NAVIGATION -->
 <nav class="bottom-nav fixed bottom-0 w-full flex justify-between items-center px-8 z-40">
    <!-- Biler -->
    <button onclick="tab('cars')" class="flex flex-col items-center justify-center w-16 text-blue-500 transition-colors" id="nav-btn-cars">
        <span class="material-icons-round text-2xl mb-1">directions_car</span>
        <span class="text-[9px] font-bold uppercase tracking-wider">Biler</span>
    </button>

    <!-- Main Action (Center) -->
    <div class="relative -top-6 z-50">
        <button onclick="openActionMenu()" class="big-fab text-white active:scale-95 transition-transform">
            <span class="material-icons-round text-4xl">add</span>
        </button>
    </div>

    <!-- Mer -->
    <button onclick="togMenu()" class="flex flex-col items-center justify-center w-16 text-slate-500 hover:text-slate-300 transition-colors" id="nav-btn-more">
        <span class="material-icons-round text-2xl mb-1">menu</span>
        <span class="text-[9px] font-bold uppercase tracking-wider">Mer</span>
    </button>
 </nav>
</div> 
<!-- END OF APP -->

<!-- MENU & MODALS -->

<!-- HAMBURGER MENU -->
<div id="menu-bg" class="fixed inset-0 z-[45]" onclick="togMenu()"></div>
<div id="more-menu" class="fixed bottom-0 w-full bg-[#1e1e1e] z-[50] rounded-t-3xl shadow-2xl flex flex-col pb-8 safe-b transform translate-y-full">
  <div class="swipe w-full h-8 flex justify-center items-center" onpointerdown="swipe(event,'more-menu')"><div class="bar"></div></div>
  <div class="p-4 space-y-2">
   <button onclick="tab('logg');togMenu()" class="w-full bg-slate-800 p-4 rounded-xl text-left flex gap-4 items-center border border-slate-700"><span class="material-icons-round text-blue-400">history</span> Logg</button>
   <button onclick="tab('admin');togMenu()" class="w-full bg-slate-800 p-4 rounded-xl text-left flex gap-4 items-center border border-slate-700"><span class="material-icons-round text-orange-400">warehouse</span> Billager</button>
   <button onclick="tab('set');togMenu()" class="w-full bg-slate-800 p-4 rounded-xl text-left flex gap-4 items-center border border-slate-700"><span class="material-icons-round text-slate-400">settings</span> Innstillinger</button>
   <a href="https://bbmanual.pages.dev/" target="_blank" class="w-full bg-slate-800 p-4 rounded-xl text-left flex gap-4 items-center block no-underline text-white border border-slate-700"><span class="material-icons-round text-purple-400">auto_stories</span> Brukermanual</a>
   <button onclick="logout()" class="w-full bg-red-900/20 text-red-400 p-4 rounded-xl text-left flex gap-4 mt-6 items-center border border-red-900/30"><span class="material-icons-round">logout</span> Logg ut</button>
  </div>
</div>

<!-- ACTIONS MODAL -->
<div id="m-action" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden modal-bottom pb-6 z-[60]" onclick="closeM('m-action')">
 <div class="bg-[#0f172a] modal-content-bottom p-5 border-t border-slate-700 shadow-2xl space-y-3" onclick="event.stopPropagation()">
  <div class="swipe w-full h-8 flex justify-center items-center" onpointerdown="swipe(event,'m-action',1)"><div class="bar"></div></div>
  <h3 class="text-white font-bold text-center mb-2">Hva vil du gj√∏re?</h3>
  <button onclick="expressBook()" class="w-full bg-yellow-600/20 border border-yellow-500 p-5 rounded-2xl flex items-center justify-between hover:bg-yellow-600/30 transition-colors"><div class="flex flex-col text-left"><span class="text-white font-black text-lg">‚ö° EKSPRESS</span><span class="text-xs text-slate-400">F√∏rste ledige bil, n√•!</span></div><span class="material-icons-round text-yellow-500 text-3xl">bolt</span></button>
  <button onclick="sMode(); closeM('m-action', false)" class="w-full bg-green-900/20 border border-green-500 p-5 rounded-2xl flex items-center justify-between hover:bg-green-900/30 transition-colors"><div class="flex flex-col text-left"><span class="text-white font-black text-lg">üîç FINN LEDIG</span><span class="text-xs text-slate-400">S√∏k med tidslinje</span></div><span class="material-icons-round text-green-500 text-3xl">search</span></button>
 </div>
</div>

<!-- EKSPRESS LISTE -->
<div id="m-express-list" class="fixed inset-0 bg-black/90 hidden modal-bottom pb-6 z-[60]" onclick="closeM('m-express-list')">
    <div class="bg-[#0f172a] modal-content-bottom p-5 border-t border-slate-700 shadow-2xl" onclick="event.stopPropagation()">
        <div class="swipe w-full h-8 flex justify-center items-center" onpointerdown="swipe(event,'m-express-list',1)"><div class="bar"></div></div>
        <div class="flex justify-between items-center mb-2">
            <h3 class="text-white font-bold text-lg">Ekspress</h3>
            <span class="text-xs text-slate-500 font-mono" id="exp-time-range"></span>
        </div>
        
        <!-- INTEGRATED INFO AND SLIDER BOX -->
        <div class="bg-slate-800 border border-blue-500/30 rounded-2xl p-3 mb-4 text-center shadow-xl relative overflow-visible">
            
            <!-- Info Text Content (UPDATED SIZES) -->
            <div class="mb-2">
                <span class="text-slate-400 text-[10px] font-bold uppercase tracking-widest block mb-0.5">Du reserverer i</span>
                <div class="flex items-baseline justify-center gap-2 mb-1">
                    <span id="exp-slider-val" class="text-xl font-black text-white tracking-tight">1 time</span>
                </div>
                <div class="text-blue-300 text-lg font-bold bg-blue-900/40 inline-block px-3 py-1 rounded-full border border-blue-500/20 mt-1">
                    Ferdig kl <span id="exp-end-time" class="font-mono text-white">--:--</span>
                </div>
            </div>

            <!-- Integrated Slider -->
            <div class="relative w-full h-10 flex items-center justify-center">
                 <!-- TICKS (Hvite prikker) -->
                <div class="flex justify-between px-[12px] w-full absolute z-0 pointer-events-none">
                    <div class="w-1.5 h-1.5 bg-white/20 rounded-full"></div>
                    <div class="w-1.5 h-1.5 bg-white/20 rounded-full"></div>
                    <div class="w-1.5 h-1.5 bg-white/20 rounded-full"></div>
                    <div class="w-1.5 h-1.5 bg-white/20 rounded-full"></div>
                    <div class="w-1.5 h-1.5 bg-white/20 rounded-full"></div>
                    <div class="w-1.5 h-1.5 bg-white/20 rounded-full"></div>
                    <div class="w-1.5 h-1.5 bg-white/20 rounded-full"></div>
                    <div class="w-1.5 h-1.5 bg-white/20 rounded-full"></div>
                    <div class="w-1.5 h-1.5 bg-white/20 rounded-full"></div>
                    <div class="w-1.5 h-1.5 bg-white/20 rounded-full"></div>
                    <div class="w-1.5 h-1.5 bg-white/20 rounded-full"></div>
                    <div class="w-1.5 h-1.5 bg-white/20 rounded-full"></div>
                </div>
                
                <input type="range" id="exp-slider" min="1" max="12" value="1" step="1"
                       class="w-full h-full bg-transparent appearance-none cursor-pointer relative z-20 focus:outline-none"
                       oninput="handleExpSlider(this.value)"
                       ontouchstart="event.stopPropagation()"
                       ontouchmove="event.stopPropagation()">
            </div>
            
             <div class="flex justify-between text-[10px] font-bold text-slate-500 mt-0 px-1">
                <span>1t</span>
                <span>12t</span>
            </div>
        </div>

        <div id="express-options" class="space-y-2 overflow-y-auto pb-4 max-h-[40vh]"></div>
    </div>
</div>

<!-- EKSPRESS BEKREFTELSE (NY) -->
<div id="m-express-conf" class="fixed inset-0 bg-black/90 hidden modal-bottom pb-6 z-[65]" onclick="closeM('m-express-conf')">
 <div class="bg-[#0f172a] modal-content-bottom p-6 border-t border-slate-700 shadow-2xl" onclick="event.stopPropagation()">
  <div class="swipe w-full h-8 flex justify-center items-center" onpointerdown="swipe(event,'m-express-conf',1)"><div class="bar"></div></div>
  <h2 class="text-white font-black text-xl uppercase mb-1">Bekreft Ekspress</h2>
  <p id="exp-conf-txt" class="text-slate-400 text-xs mb-6"></p>
  
  <div class="mb-6">
      <label class="text-[10px] font-bold text-slate-500 block mb-1">FORM√ÖL</label>
      <input id="exp-conf-form" placeholder="F.eks. M√∏te" class="w-full bg-slate-800 p-4 rounded-xl border border-slate-600 text-white text-sm">
  </div>

  <button onclick="confirmExpress()" class="w-full bg-blue-600 py-4 rounded-xl font-black text-white text-lg shadow-lg">BEKREFT</button>
  <button onclick="closeM('m-express-conf')" class="w-full text-slate-500 font-bold py-4 mt-2">AVBRYT</button>
 </div>
</div>

<!-- S√òK (Finn Ledig) - Added Touch Listeners here -->
<div id="m-search" class="fixed inset-0 bg-black/90 hidden modal-bottom pb-6 z-[60]" onclick="closeM('m-search')"
     ontouchstart="handleTouchStart(event)" ontouchend="modalTouchEnd(event, 'm-search')">
 <div class="bg-[#0f172a] modal-content-bottom p-5 border-t border-slate-700 shadow-2xl relative" onclick="event.stopPropagation()">
  <div class="swipe w-full h-8 flex justify-center items-center" onpointerdown="swipe(event,'m-search',1)"><div class="bar"></div></div>
  <button onclick="closeM('m-search')" class="absolute top-4 right-4 text-slate-500 p-2"><span class="material-icons-round">close</span></button>
  <div class="flex items-center gap-4 mb-4">
      <h2 class="text-xl font-black text-white">FINN LEDIG</h2>
      <div class="legend-box"><div class="legend-item"><div class="dot free"></div> Ledig</div><div class="legend-item"><div class="dot selected"></div> Valgt</div><div class="legend-item"><div class="dot busy"></div> Opptatt</div></div>
  </div>
  <div class="mb-4">
    <!-- Updated Dynamic Date Display -->
    <div id="s-tl-date-disp" class="text-center text-sm font-black text-blue-100 uppercase tracking-widest mb-2 bg-blue-900/40 border border-blue-800 p-2 rounded shadow-sm">I DAG</div>
    <div class="timeline-scroll" id="ts-search" onscroll="handleTimelineScroll('search')"><div class="time-grid" id="timeline-search"></div></div>
  </div>
  <p id="s-instr" class="text-center text-xs text-slate-500 font-bold mb-1 uppercase">Trykk starttid (A)</p>
  
  <!-- REVISED DATE LAYOUT FOR SEARCH (MATCHING BOOKING) -->
  <div id="v-s-e" class="flex flex-col gap-3 mb-6 bg-slate-800 p-4 rounded-xl border border-slate-700">
    <div class="flex items-center gap-2">
        <div class="w-12 text-[10px] font-bold text-slate-500 uppercase pt-2">Fra</div>
        <input type="date" id="s-d-st" class="bg-slate-900 text-white text-sm font-bold h-10 px-2 rounded w-full border border-slate-600" onchange="synS('start')">
        <input type="time" id="s-t-st" class="bg-slate-900 text-blue-400 text-sm font-black h-10 px-2 rounded w-24 text-center border border-slate-600" onchange="synS()">
    </div>
    <div class="flex items-center gap-2">
        <div class="w-12 text-[10px] font-bold text-slate-500 uppercase pt-2">Til</div>
        <input type="date" id="s-d-en" class="bg-slate-900 text-white text-sm font-bold h-10 px-2 rounded w-full border border-slate-600" onchange="synS()">
        <input type="time" id="s-t-en" class="bg-slate-900 text-blue-400 text-sm font-black h-10 px-2 rounded w-24 text-center border border-slate-600" onchange="synS()">
    </div>
  </div>
  
  <div id="s-res" class="space-y-2 mb-4 hidden border-t border-slate-800 pt-4 overflow-y-auto max-h-[30vh]"></div>
  <button onclick="findC()" class="w-full bg-blue-600 py-4 rounded-xl font-bold text-white shadow-lg text-sm mb-4">S√òK ETTER BIL</button>
 </div>
</div>

<!-- BOOKING MODAL -->
<div id="m-book" class="fixed inset-0 bg-black/90 hidden modal-bottom pb-6 z-[60]" onclick="closeM('m-book')">
 <div class="bg-[#0f172a] modal-content-bottom p-5 border-t border-slate-700 shadow-2xl relative" id="m-book-content" onclick="event.stopPropagation()">
  <button onclick="closeM('m-book')" class="absolute top-4 right-4 text-slate-500 p-2"><span class="material-icons-round">close</span></button>
  <div class="flex items-center gap-4 mb-2 overflow-hidden w-full pr-10">
      <h2 id="b-title" class="text-xl font-black text-white uppercase flex items-center overflow-hidden w-full">RESERVER</h2>
      <!-- Legend removed from header to make space for chips -->
  </div>
  
  <!-- NEW SUBTITLE with Details (Moved here from JS injection) -->
  <h3 id="b-sub" class="text-sm text-slate-300 mb-2 font-bold flex flex-col">
      <span>Ny reservasjon</span>
  </h3>
  
  <!-- New Warning Box for Foreign Booking -->
  <div id="b-owner-warn" class="hidden mb-4 bg-orange-900/30 border border-orange-500/50 p-4 rounded-xl flex items-center gap-3">
    <span class="material-icons-round text-orange-500 text-2xl">warning</span>
    <div>
        <h3 class="text-orange-400 font-bold text-xs uppercase">Advarsel</h3>
        <p class="text-orange-200 text-xs">Du redigerer en reservasjon som tilh√∏rer <span id="b-owner-name" class="font-black text-white"></span>.</p>
    </div>
  </div>

  <p id="b-info" class="text-xs text-yellow-500 mb-3 bg-yellow-900/20 p-2 rounded border border-yellow-700/50 hidden"></p>
  <div class="mb-4">
    <!-- Updated Dynamic Date Display -->
    <div id="b-tl-date-disp" class="text-center text-sm font-black text-blue-100 uppercase tracking-widest mb-2 bg-blue-900/40 border border-blue-800 p-2 rounded shadow-sm">I DAG</div>
    <div class="timeline-scroll" id="ts-book" onscroll="handleTimelineScroll('book')"><div class="time-grid" id="timeline"></div></div>
  </div>
  <p id="b-instr" class="text-center text-xs text-slate-500 font-bold mb-1 uppercase">Trykk starttid (A)</p>
  
  <div class="flex flex-col gap-3 mb-4 bg-slate-800 p-4 rounded-xl border border-slate-700" id="b-date-inputs">
    <div class="flex items-center gap-2">
        <div class="w-12 text-[10px] font-bold text-slate-500 uppercase pt-2">Fra</div>
        <input type="date" id="b-d-st" class="bg-slate-900 text-white text-sm font-bold h-10 px-2 rounded w-full border border-slate-600" onchange="check('start')">
        <input type="time" id="b-t-st" class="bg-slate-900 text-blue-400 text-sm font-black h-10 px-2 rounded w-24 text-center border border-slate-600" onchange="check()">
    </div>
    <div class="flex items-center gap-2">
        <div class="w-12 text-[10px] font-bold text-slate-500 uppercase pt-2">Til</div>
        <input type="date" id="b-d-en" class="bg-slate-900 text-white text-sm font-bold h-10 px-2 rounded w-full border border-slate-600" onchange="check()">
        <input type="time" id="b-t-en" class="bg-slate-900 text-blue-400 text-sm font-black h-10 px-2 rounded w-24 text-center border border-slate-600" onchange="check()">
    </div>
  </div>

  <div class="mb-3"><details class="group"><summary class="text-blue-400 text-xs font-bold cursor-pointer list-none flex items-center gap-1 mb-2"><span class="material-icons-round text-sm">add_circle_outline</span> Legg til flere biler</summary><div id="b-multi" class="flex flex-wrap gap-2 p-2 bg-slate-800 rounded-lg border border-slate-700"></div></details></div>
  <div id="b-alert" class="hidden mb-4 bg-slate-800 border border-slate-600 p-4 rounded-xl"><p id="al-t" class="text-red-400 font-bold text-sm flex gap-2"><span class="material-icons-round">error</span> UTILGJENGELIG</p><p id="b-reason" class="text-white text-sm mb-3"></p><button id="btn-react" onclick="react()" class="w-full py-2 bg-green-700 text-white rounded font-bold text-xs hidden">GJ√òR AKTIV</button></div>
  
  <div class="mb-4 space-y-3" id="b-form-container">
    <div class="flex gap-2" id="b-form-standard">
       <div id="d-bid" class="w-1/3"><label class="text-[10px] font-bold text-slate-500">BID</label><input id="b-bid" class="w-full bg-slate-800 p-3 rounded-xl border border-slate-600 font-bold text-white text-sm"></div>
       <div class="flex-1">
         <label class="text-[10px] font-bold text-slate-500">TYPE OPPDRAG</label>
         <select id="b-form" onchange="handleFormChange()" class="w-full bg-slate-800 p-3 rounded-xl border border-slate-600 text-white text-sm h-12">
           <option value="" disabled selected>Velg...</option>
           <option value="M√∏te">M√∏te</option>
           <option value="IP">IP</option>
           <option value="Oppdrag">Oppdrag</option>
           <option value="Annet">Annet</option>
           <option value="Verksted">Verksted</option>
         </select>
       </div>
    </div>
    
    <!-- New Extra Info Field -->
    <div id="d-extra" class="hidden">
        <label id="l-extra" class="text-[10px] font-bold text-slate-500">TILLEGGSINFO</label>
        <input id="b-extra" class="w-full bg-slate-800 p-3 rounded-xl border border-slate-600 text-white text-sm">
    </div>

    <div class="hidden flex-col gap-2 bg-purple-900/20 p-3 rounded-xl border border-purple-500" id="b-form-verksted">
       <div class="flex justify-between items-center">
           <span class="text-purple-400 font-bold text-xs uppercase"><span class="material-icons-round text-sm align-text-bottom">build</span> Verksted / Service</span>
           <button onclick="handleFormChange(true)" class="text-slate-400 hover:text-white"><span class="material-icons-round">close</span></button>
       </div>
       <label class="text-[10px] font-bold text-slate-500">HVA SKAL GJ√òRES?</label>
       <input id="b-verksted-desc" class="w-full bg-slate-900 p-3 rounded-xl border border-purple-500/50 text-white text-sm font-bold" placeholder="F.eks. Service, Dekk, EU-kontroll...">
    </div>
    <div class="mt-2 text-xs"><div id="warn" class="hidden mt-2 p-2 bg-red-900/40 border border-red-500 text-red-200 font-bold rounded text-center">‚ö† OPPTATT I TIDSROMMET</div></div>
    <div class="flex gap-2 pt-2"><button id="btn-del" onclick="delB()" class="hidden py-4 px-4 rounded-xl bg-red-900/30 text-red-400 border border-red-900 flex items-center justify-center"><span class="material-icons-round">delete</span></button><button id="btn-ok" onclick="confB()" class="flex-1 py-4 rounded-xl bg-blue-600 font-bold text-white text-lg shadow-lg disabled:opacity-50 disabled:bg-gray-600">BEKREFT</button></div>
  </div>

  <div class="border-t border-slate-800 pt-4 mt-4 pb-10">
      <h4 class="text-[10px] font-bold text-slate-500 uppercase mb-3">Kommende turer (Trykk for √• endre)</h4>
      <div id="fut-l" class="space-y-2"></div>
  </div>
 </div>
</div>

<!-- LEVERING MODAL -->
<div id="m-ret" class="fixed inset-0 bg-black/90 hidden modal-bottom pb-6 z-[60]" onclick="closeM('m-ret')">
 <div class="bg-[#0f172a] modal-content-bottom p-6 border-t border-slate-700 shadow-2xl" onclick="event.stopPropagation()">
  <div class="swipe w-full h-8 flex justify-center items-center" onpointerdown="swipe(event,'m-ret',1)"><div class="bar"></div></div>
  <h2 class="text-white font-black text-2xl uppercase mb-1">Levering</h2><p id="r-name" class="text-blue-400 font-bold uppercase mb-6 text-sm"></p>
  <div class="bg-blue-900/20 border border-blue-800 p-4 rounded-xl mb-6">
      <h3 class="text-blue-400 font-bold text-sm mb-1 flex items-center gap-2"><span class="material-icons-round text-sm">info</span> Informasjon</h3>
      <p class="text-xs text-slate-300">Kommentar du skriver her blir synlig p√• bilkortet for neste bruker. I tillegg sendes det automatisk en e-post til bilansvarlig.</p>
  </div>
  <div class="bg-yellow-900/30 border border-yellow-600/50 p-4 rounded-xl mb-6 flex items-center gap-4"><div class="bg-yellow-600/20 p-3 rounded-full"><span class="material-icons-round text-yellow-500 text-3xl">vpn_key</span></div><div><h3 class="text-yellow-500 font-black text-sm">HUSK N√òKLER!</h3><p class="text-yellow-200/80 text-xs">Legg tilbake i skapet.</p></div></div>
  <input id="r-comm" placeholder="Kommentar (Sendes til bilansvarlig + notat p√• bil)" class="w-full bg-slate-800 p-4 rounded-xl border border-slate-600 text-white mb-4 text-sm">
  <button onclick="subRet()" class="w-full bg-green-600 py-4 rounded-xl font-black text-white text-lg shadow-lg">BEKREFT</button><button onclick="closeM('m-ret')" class="w-full text-slate-500 font-bold py-4 mt-2">AVBRYT</button>
 </div>
</div>

<!-- ADMIN REDIGER MODAL -->
<div id="m-admin-edit" class="fixed inset-0 bg-black/90 hidden modal-bottom pb-6 z-[60]" onclick="closeM('m-admin-edit')">
 <div class="bg-[#0f172a] modal-content-bottom p-5 border-t border-slate-700 shadow-2xl relative" onclick="event.stopPropagation()">
  <div class="swipe w-full h-8 flex justify-center items-center" onpointerdown="swipe(event,'m-admin-edit',1)"><div class="bar"></div></div>
  <h2 class="text-xl font-black text-white mb-4" id="adm-title">Rediger Bil</h2>
  <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 space-y-4">
      <div class="grid grid-cols-2 gap-4">
          <div>
              <label class="text-[10px] font-bold text-slate-500">NAVN/REGNR</label>
              <input type="text" id="adm-name" class="w-full p-3 rounded bg-slate-900 border border-slate-600 text-white text-sm font-bold uppercase">
          </div>
          <div>
              <label class="text-[10px] font-bold text-slate-500">ANSVARLIG</label>
              <input type="text" id="adm-resp" class="w-full p-3 rounded bg-slate-900 border border-slate-600 text-white text-sm" placeholder="F.eks. Olsen">
          </div>
      </div>
      
      <!-- NYTT FELT: KATEGORI -->
      <div>
          <label class="text-[10px] font-bold text-slate-500">KATEGORI (Bilsymbol)</label>
          <select id="adm-cat" class="w-full p-3 rounded bg-slate-900 border border-slate-600 text-white text-sm">
            <option value="Uniformert">Uniformert</option>
            <option value="Sivil">Sivil</option>
            <option value="Admin">Admin</option>
          </select>
      </div>

      <div><label class="text-[10px] font-bold text-slate-500">STATUS</label><select id="adm-stat" class="w-full p-3 rounded bg-slate-900 border border-slate-600 text-white text-sm"><option value="Aktiv">Aktiv</option><option value="Verksted">Verksted</option><option value="Skade">Skade</option><option value="EU-kontroll">EU-kontroll</option><option value="Annet">Annet</option></select></div>
      <div><label class="text-[10px] font-bold text-slate-500">KOMMENTAR (SYNLIG)</label><input type="text" id="adm-comm" class="w-full p-3 rounded bg-slate-900 border border-slate-600 text-white text-sm" placeholder="Skriv beskjed..."></div>
      <div><label class="text-[10px] font-bold text-slate-500">INTERN INFO</label><textarea id="adm-info" class="w-full p-3 rounded bg-slate-900 border border-slate-600 text-white text-sm h-24" placeholder="Notater kun for admin..."></textarea></div>
  </div>
  <div class="flex gap-2 mt-4"><button id="btn-adm-del" onclick="delC(s.admId, $id('adm-name').value)" class="p-4 rounded-xl bg-red-900/30 text-red-400 border border-red-900"><span class="material-icons-round">delete</span></button><button onclick="saveAdmCar()" class="flex-1 bg-blue-600 py-4 rounded-xl font-bold text-white shadow-lg text-sm">LAGRE ENDRINGER</button></div>
 </div>
</div>

<script>
const JOB_DOMAIN = "@politiet.no"; 
const S_URL = "https://huxyflpzmfajrvluhxaw.supabase.co";
const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1eHlmbHB6bWZhanJ2bHVoeGF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODk1NDYsImV4cCI6MjA4NDE2NTU0Nn0.7obBykQfPmfxxzHf348iDO9aHWldQPqibnRKlrMDHAI";

const $id = (id) => document.getElementById(id);
const _s = supabase.createClient(S_URL, S_KEY);

let s = { u:null, bid:null, c:[], r:[], fullLog: null, sel:[], co:null, editId:null, v:'cars', f:{c:'all',d:'',m:false}, h:JSON.parse(localStorage.getItem('h')||'[]'), rid:null, rc:null, savedEmail: '', varsel: true, deferredPrompt: null, activeModal: null, tlClick: 0, admCar: null, admId: null, oldAdmCarName: null, tlDay: 0, expDur: 1, bilansvarlig: '', workshopMode: false, expCar: null, expStart: null, expEnd: null, visType: localStorage.getItem('visType') !== 'false', visResp: localStorage.getItem('visResp') === 'true', uiLarge: localStorage.getItem('uiLarge') === 'true' };
let touchStartX = 0;
let touchStartY = 0; 

// Initialiser UI Size ved oppstart
if(s.uiLarge) document.body.classList.add('ui-large');

if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); s.deferredPrompt = e; const setBtn = $id('pwa-settings-btn'); if(setBtn) setBtn.classList.remove('hidden'); const icon = $id('install-icon'); if(icon) icon.classList.remove('hidden'); });
async function installPwa() { if(s.deferredPrompt) { s.deferredPrompt.prompt(); const { outcome } = await s.deferredPrompt.userChoice; if (outcome === 'accepted') { s.deferredPrompt = null; $id('install-icon').classList.add('hidden'); $id('pwa-settings-btn').classList.add('hidden'); } } }
function closePwaToast() { $id('pwa-toast').classList.add('hidden'); }
window.addEventListener('online', () => $id('offline-msg').classList.add('hidden'));
window.addEventListener('offline', () => $id('offline-msg').classList.remove('hidden'));
_s.auth.onAuthStateChange((event, session) => { if (session) { s.u = session.user.email; s.bid = s.u.split('@')[0].toUpperCase(); $id('auth').classList.add('hidden'); $id('app').classList.remove('hidden'); $id('u-disp').innerText = "Bruker: " + s.bid; tab('cars'); load(); } else { $id('auth').classList.remove('hidden'); $id('app').classList.add('hidden'); s.u = null; s.bid = null; }});
function showToast(msg, type = 'info') { const c = $id('toast-container'); const t = document.createElement('div'); t.className = `toast toast-${type}`; let icon = type==='success'?'check_circle':(type==='error'?'error':'info'); t.innerHTML = `<span class="material-icons-round text-lg">${icon}</span> <span>${msg}</span>`; c.appendChild(t); setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300)},3000); }
window.onpopstate = (event) => { if (s.activeModal) closeM(s.activeModal, false); };
function openM(id) { if (s.activeModal === id) return; $id(id).classList.remove('hidden'); s.activeModal = id; history.pushState({modal: id}, null, ""); }
function closeM(id, back=true) { $id(id).classList.add('hidden'); s.activeModal = null; if(back) history.back(); }

function tab(v) { 
    s.v=v; 
    render(); 
    updNav(v); 
    // Force load on any main tab switch to ensure data is fresh
    if(['cars', 'res', 'mine'].includes(v)) load(); 
    if(v === 'logg') loadFullHistory(); 
}
function updNav(v) { 
    const tc = $id('nav-btn-cars'); const tm = $id('nav-btn-more');
    tc.className = "flex flex-col items-center justify-center w-16 text-slate-500 transition-colors"; tm.className = "flex flex-col items-center justify-center w-16 text-slate-500 transition-colors";
    if(['cars','res','mine'].includes(v)) tc.className = "flex flex-col items-center justify-center w-16 text-blue-500 transition-colors"; else tm.className = "flex flex-col items-center justify-center w-16 text-blue-500 transition-colors";
}

function handleTouchStart(e) { 
    touchStartX = e.changedTouches[0].screenX; 
    touchStartY = e.changedTouches[0].screenY;
}

function handleTouchEnd(e) {
    if(!['cars','res','mine'].includes(s.v)) return;
    const diff = touchStartX - e.changedTouches[0].screenX;
    if (Math.abs(diff) > 50) { 
        if (diff > 0) { if(s.v === 'cars') tab('res'); else if(s.v === 'res') tab('mine'); } 
        else { if(s.v === 'mine') tab('res'); else if(s.v === 'res') tab('cars'); }
    }
}

let modalTouchX = 0; let modalTouchY = 0;
function modalTouchEnd(e, id) {
    const diffX = e.changedTouches[0].screenX - touchStartX; 
    const diffY = e.changedTouches[0].screenY - touchStartY;
    if (diffX > 50 && Math.abs(diffX) > Math.abs(diffY)) {
        const tl = e.target.closest('.timeline-scroll');
        if (tl && tl.scrollLeft > 0) return; 
        closeM(id);
    }
}

function togMenu() { $id('more-menu').classList.toggle('open'); $id('menu-bg').classList.toggle('open'); }
function openActionMenu() { openM('m-action'); }
async function sendOtp() {
    const e = $id('l-email').value.trim().toLowerCase();
    if (!e.endsWith(JOB_DOMAIN)) return showToast(`Kun ${JOB_DOMAIN}`, 'error');
    const bidPattern = /^[a-z√¶√∏√•]{3}\d{3}@politiet\.no$/;
    if (!bidPattern.test(e)) return showToast("Feil format! Bruk BID (3 bokstaver + 3 tall)", "error");
    const { error } = await _s.auth.signInWithOtp({ email: e, options: { emailRedirectTo: window.location.origin } });
    if (error) showToast(error.message, 'error'); 
    else { $id('f-email').classList.add('hidden'); $id('f-otp').classList.remove('hidden'); $id('l-otp').focus(); }
}
async function verifyOtp() { const e = $id('l-email').value.trim().toLowerCase(), t = $id('l-otp').value.trim(); const { error } = await _s.auth.verifyOtp({ email: e, token: t, type: 'email' }); if (error) showToast("Feil kode.", 'error'); }
function resetAuth() { $id('f-email').classList.remove('hidden'); $id('f-otp').classList.add('hidden'); $id('l-otp').value = ""; }
async function logout() { if (confirm("Logg ut?")) { await _s.auth.signOut(); location.reload(); } }
function swipe(e,id,m=0) { e.preventDefault(); const start=e.clientY; const fn=()=>{ if(event.clientY-start>50) { if(m)closeM(id); else togMenu(); } document.removeEventListener('pointerup',fn); }; document.addEventListener('pointerup',fn); }

async function load() {
    if(!s.u || (document.activeElement && ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName))) return;
    try {
        // Henter data separat for √• unng√• at feil i √©n sp√∏rring stopper alt
        const c = await _s.from('biler').select('*').order('bil');
        const r = await _s.from('bookinger').select('*'); // Henter alt for √• v√¶re sikker
        const u = await _s.from('brukere').select('epost, varsel').eq('brukernavn', s.bid).maybeSingle();
        const conf = await _s.from('konfigurasjon').select('*').eq('nokkel', 'bilansvarlig_epost').maybeSingle();

        if (c.error) console.error("Feil ved henting av biler:", c.error);
        if (r.error) console.error("Feil ved henting av bookinger:", r.error);

        s.c = c.data || [];
        s.r = r.data || [];
        
        if(u.data) { s.savedEmail = u.data.epost; s.varsel = u.data.varsel; }
        if(conf.data) { s.bilansvarlig = conf.data.verdi; }
        
        // Oppdatert header-visning
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'});
        $id('u-disp').innerHTML = `Bruker: ${s.bid} <span class="opacity-50 mx-1">‚Ä¢</span> <span class="material-icons-round text-xs align-middle opacity-50">refresh</span> <span class="font-normal opacity-75">${time}</span>`;
        
        render();
    } catch(e) { 
        console.error("Kritisk feil i load():", e); 
        showToast("Feil ved lasting av data", "error");
    }
}

async function loadFullHistory() {
    const listDiv = document.querySelector('#main .space-y-3'); 
    if(listDiv) listDiv.innerHTML = "<div class='text-center text-slate-500 mt-10'>Laster full historikk...</div>";
    const { data, error } = await _s.from('bookinger').select('*').order('start_tid', { ascending: false }).limit(1000);
    if(!error) { s.fullLog = data; render(); }
}

function render() {
    if (document.activeElement.tagName === "INPUT" && s.v === 'set') return;
    const c=$id('main'); c.innerHTML=""; 
    const stats = $id('head-stats'); const title = $id('pg-t');
    const tabsContainer = $id('head-tabs');
    
    if(stats) stats.classList.remove('hidden'); 
    if(tabsContainer) tabsContainer.classList.remove('hidden'); 
    if(title) title.innerText = "BookBil J√¶ren";
    
    // Update segmented control tabs
    ['ov','res','mine'].forEach(x => { const el = $id('tab-'+x); if(el) el.className = "seg-tab"; });
    if(s.v==='cars') { $id('tab-ov').className = "seg-tab active"; rCars(c); }
    else if(s.v==='res') { $id('tab-res').className = "seg-tab active"; rRes(c, false); }
    else if(s.v==='mine') { $id('tab-mine').className = "seg-tab active"; rRes(c, true); }
    else {
        if(stats) stats.classList.add('hidden'); 
        if(tabsContainer) tabsContainer.classList.add('hidden');
        if(s.v==='admin') { if(title) title.innerText = "Billager"; rAdm(c); }
        else if(s.v==='logg') { if(title) title.innerText = "Logg"; rLog(c); }
        else if(s.v==='set') { if(title) title.innerText = "Innstillinger"; rSet(c); }
    }
    calcStats();
}

function calcStats() {
    const now = new Date(); let total = 0; let free = 0;
    s.c.forEach(b => {
        if(s.h.includes(b.bil)) return;
        total++;
        if(b.status === 'Aktiv') {
            const isBusy = s.r.some(r => r.bil===b.bil && new Date(r.start_tid)<=now && new Date(r.slutt_tid)>=now);
            if(!isBusy) free++;
        }
    });
    
    const statFree = $id('stat-free');
    const statTotal = $id('stat-total');
    
    statFree.innerText = free; 
    statTotal.innerText = total;

    // Gradvis fargeendring basert p√• tilgjengelighet
    statFree.className = "block text-2xl font-bold leading-none"; // Reset classes
    if (free === 0) {
        statFree.classList.add("text-red-500");
    } else if (free <= 3) {
        statFree.classList.add("text-orange-500");
    } else {
        statFree.classList.add("text-emerald-400");
    }
}

function getBadgesHtml(b, large=false, showResp=true, showType=true) {
    if(!b) return '';
    let html = '';
    const size = large ? "text-[10px] px-2 py-1" : "text-[9px] px-1.5 py-0.5";
    const iconSize = large ? "text-xs" : "text-[10px]";
    if(showType) {
        if(b.kategori === 'Uniformert') { html += `<span class="${size} bg-blue-600 text-white rounded border border-blue-500 font-bold uppercase whitespace-nowrap">${b.kategori.toUpperCase()}</span>`; } 
        else if(b.kategori === 'Sivil') { html += `<span class="${size} bg-blue-900/40 text-blue-300 rounded border border-blue-800 font-bold uppercase whitespace-nowrap">${b.kategori.toUpperCase()}</span>`; } 
        else if(b.kategori === 'Admin') { html += `<span class="${size} bg-gray-800 text-gray-500 rounded border border-gray-700 font-bold uppercase whitespace-nowrap">ADMIN</span>`; }
    }
    if(showResp && b.ansvarlig) { html += `<span class="${size} bg-slate-700 text-slate-300 rounded border border-slate-600 font-bold uppercase whitespace-nowrap flex items-center gap-1"><span class="material-icons-round ${iconSize}">person</span> ${b.ansvarlig}</span>`; }
    return html;
}

function rCars(c) {
    const now = new Date();
    const twoHours = 2 * 60 * 60 * 1000;
    let myNextTrip = s.r.find(r => r.bid === s.bid && new Date(r.start_tid) <= now && new Date(r.slutt_tid) >= now);
    let tripStatus = "active";
    if (!myNextTrip) {
        myNextTrip = s.r.filter(r => r.bid === s.bid && new Date(r.start_tid) > now && (new Date(r.start_tid) - now) < twoHours).sort((a,b) => new Date(a.start_tid) - new Date(b.start_tid))[0];
        tripStatus = "upcoming";
    }

    if (myNextTrip) {
        const tripCar = myNextTrip.bil;
        const st = new Date(myNextTrip.start_tid);
        const en = new Date(myNextTrip.slutt_tid);
        const card = document.createElement('div');
        card.className = "bg-blue-900/40 border border-blue-500/50 p-4 rounded-xl mb-6 shadow-lg relative overflow-hidden cursor-pointer active:scale-95 transition-transform";
        card.onclick = () => book(tripCar, myNextTrip.id);
        let headerText = "", timeText = "", actionBtn = "";
        if (tripStatus === "active") {
            headerText = `<span class="flex items-center gap-1 text-emerald-400 font-black uppercase text-[10px] tracking-widest"><span class="material-icons-round text-sm animate-pulse">circle</span> P√•g√•ende tur</span>`;
            timeText = `<div class="text-xs text-blue-200 mt-1">Leveringsfrist: <span class="font-mono font-bold text-white">${fmtT(en)}</span></div>`;
            actionBtn = `<button onclick="event.stopPropagation();ret(${myNextTrip.id},'${tripCar}')" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg text-xs shadow-lg transition-colors">LEVER N√Ö</button>`;
        } else {
            const minutesToStart = Math.ceil((st - now) / 60000);
            headerText = `<span class="flex items-center gap-1 text-amber-400 font-black uppercase text-[10px] tracking-widest"><span class="material-icons-round text-sm">schedule</span> Starter snart</span>`;
            timeText = `<div class="text-xs text-blue-200 mt-1">Starter om <span class="font-mono font-bold text-white">${minutesToStart} min</span> (${fmtT(st)})</div>`;
            actionBtn = `<button onclick="event.stopPropagation();book('${tripCar}', ${myNextTrip.id})" class="bg-slate-700 hover:bg-slate-600 border border-slate-500 text-white font-bold py-2 px-4 rounded-lg text-xs shadow-lg transition-colors">SE KORT</button>`;
        }
        card.innerHTML = `<div class="flex justify-between items-center relative z-10"><div>${headerText}<h2 class="text-2xl font-black text-white mt-1 leading-none">${tripCar}</h2>${timeText}</div><div>${actionBtn}</div></div><div class="absolute -right-6 -bottom-8 opacity-10 pointer-events-none"><span class="material-icons-round text-9xl text-white">directions_car</span></div>`;
        c.appendChild(card);
    }

    const wrapper = document.createElement('div');
    wrapper.className = "flex flex-col rounded-xl overflow-hidden shadow-lg border border-slate-700/50 mb-6";
    const sortedCars = [...s.c].sort((a, b) => {
        const actA = s.r.some(r => r.bil === a.bil && new Date(r.start_tid) <= now && new Date(r.slutt_tid) >= now && r.bid === s.bid);
        const actB = s.r.some(r => r.bil === b.bil && new Date(r.start_tid) <= now && new Date(r.slutt_tid) >= now && r.bid === s.bid);
        if (actA && !actB) return -1; if (!actA && actB) return 1;
        const catOrder = { 'Uniformert': 1, 'Sivil': 2, 'Admin': 3 };
        const pA = catOrder[a.kategori] || 4; const pB = catOrder[b.kategori] || 4;
        if (pA !== pB) return pA - pB;
        return a.bil.localeCompare(b.bil);
    });

    const tomorrow = new Date(now); tomorrow.setDate(tomorrow.getDate() + 1); tomorrow.setHours(0,0,0,0);

    sortedCars.forEach(b => {
        if(s.h.includes(b.bil)) return;
        const act = s.r.find(r => r.bil===b.bil && new Date(r.start_tid)<=now && new Date(r.slutt_tid)>=now);
        const nxt = s.r.filter(r => r.bil===b.bil && new Date(r.start_tid)>now).sort((a,x)=>new Date(a.start_tid)-new Date(x.start_tid))[0];
        let stripeClass="c-green", titleColor="text-white", subText="Ledig n√•", subColor="text-emerald-500", rowBg="", rowOp="opacity-100";
        let actionBtn = `<button onclick="event.stopPropagation();book('${b.bil}')" class="btn-action btn-green">RESERVER</button>`;

        if(b.status!=='Aktiv') { 
            // Default setup for unavailable cars (Gray)
            stripeClass="c-gray"; 
            titleColor="text-slate-500"; 
            subColor="text-slate-500"; 
            rowOp="opacity-75"; 
            subText = b.kommentar ? b.kommentar : "Ute av drift";

            // Specific overrides for color
            if(b.status === 'Verksted') { 
                stripeClass="c-purple"; 
                titleColor="text-slate-400"; 
                subColor="text-purple-400"; 
                subText = "P√• verksted" + (b.kommentar ? ": " + b.kommentar : "");
            } 
            else if(b.status === 'EU-kontroll') { 
                stripeClass="c-purple"; 
                titleColor="text-slate-400"; 
                subColor="text-purple-400"; 
                subText = "EU-kontroll" + (b.kommentar ? ": " + b.kommentar : "");
            }
            
            actionBtn = `<button onclick="event.stopPropagation();stat(${b.id},'Aktiv','${b.bil}')" class="btn-action btn-green">KLAR</button>`;
        }
        else if(act) { 
            stripeClass="c-red"; titleColor="text-slate-400"; subColor="text-slate-500"; rowOp="opacity-75";
            subText = `Opptatt av ${act.bid} til ${fmtT(act.slutt_tid)}`;
            if(act.formal && (act.formal.includes('Verksted') || act.formal.includes('Service'))) {
                 stripeClass="c-purple"; subText="P√• verksted"; subColor="text-purple-400"; rowOp="opacity-70";
                 actionBtn = `<button onclick="event.stopPropagation();ret(${act.id},'${b.bil}', 'verksted')" class="btn-action btn-green">HENTET</button>`;
            } else {
                 actionBtn = `<div class="text-right pr-2"><span class="block text-[9px] text-slate-500 uppercase">Ledig</span><span class="block text-xs font-bold text-slate-300 font-mono">${fmtT(act.slutt_tid)}</span></div>`;
            }
        }
        else if(nxt) { 
            const nxtStart = new Date(nxt.start_tid);
            if (nxtStart < tomorrow) { stripeClass="c-yellow"; subText = `Ledig til kl ${fmtT(nxt.start_tid)}`; subColor="text-amber-500"; } 
            else { stripeClass="c-green"; subText = `Ledig til ${fmtDD(nxt.start_tid)} kl ${fmtT(nxt.start_tid)}`; subColor="text-emerald-400"; }
        } else { subText = "Ledig n√•"; }
        if (b.status === 'Aktiv' && b.kommentar) { subText = `‚ö† ${b.kommentar}`; subColor = "text-yellow-500"; }

        const row = document.createElement('div');
        row.className = `fleet-row ${rowBg} ${rowOp}`;
        row.onclick = () => book(b.bil);
        let minBilTag = (act && act.bid === s.bid) ? `<span class="text-[9px] bg-blue-500/20 text-blue-300 px-1.5 py-0.5 rounded font-bold uppercase ml-2 flex-shrink-0">Min bil</span>` : '';
        row.innerHTML = `<div class="flex items-center flex-1 min-w-0 gap-3"><div class="status-stripe ${stripeClass}"></div><div class="flex-1 min-w-0 py-1 overflow-hidden"><div class="flex items-center gap-1 overflow-x-auto no-scrollbar mask-right"><h2 class="text-base font-bold ${titleColor} leading-tight whitespace-nowrap mr-1 flex-shrink-0">${b.bil}</h2>${getBadgesHtml(b, false, s.visResp, s.visType)} ${minBilTag}</div><p class="text-xs ${subColor} mt-0.5 font-medium truncate">${subText}</p></div></div><div class="flex-shrink-0 ml-2">${actionBtn}</div>`;
        wrapper.appendChild(row);
    });
    c.appendChild(wrapper);
}

// ... (Other functions remain largely the same, updated modal handling for new fields) ...

function rRes(c, mineOnly) {
    const now=new Date(); let html = `<div class="space-y-3">`;
    let list = s.r.filter(r => new Date(r.slutt_tid) > now).sort((a,b) => new Date(a.start_tid) - new Date(b.start_tid));
    if(mineOnly) list = list.filter(r => r.bid === s.bid);
    if(list.length === 0) { c.innerHTML = "<div class='text-center text-slate-500 mt-10'>Ingen reservasjoner funnet.</div>"; return; }
    list.forEach(r => {
        const active = new Date(r.start_tid) <= now;
        const formalText = r.formal || "Ingen beskrivelse"; // Fallback text for safety
        const isVerksted = formalText.includes("Verksted") || formalText.includes("Service");
        let borderCol = active ? (isVerksted ? "border-purple-500" : "border-red-500") : "border-yellow-500";
        let bgCol = active ? (isVerksted ? "bg-purple-900/10" : "bg-red-900/10") : "bg-yellow-900/10";
        let statusTxt = active ? "P√ÖG√ÖENDE" : "KOMMENDE";
        let icon = active ? "play_circle" : "schedule";
        let actionBtns = "";
        if(isVerksted) { borderCol = "border-purple-500"; bgCol="bg-purple-900/10"; statusTxt = "VERKSTED"; icon="build"; }
        if (!isVerksted) {
            if (active && (mineOnly || r.bid === s.bid)) actionBtns = `<button onclick="event.stopPropagation();subRet(${r.id},'${r.bil}')" class="btn-action btn-primary py-2 px-4 rounded shadow-lg text-xs">LEVER N√Ö</button>`;
            else if (!active && (mineOnly || r.bid === s.bid)) actionBtns = `<button onclick="event.stopPropagation();book('${r.bil}',${r.id})" class="btn-action btn-amber py-2 px-4 rounded shadow-lg text-xs">ENDRE</button>`;
        }
        html += `<div onclick="book('${r.bil}',${r.id})" class="${bgCol} border-l-4 ${borderCol} p-4 rounded-r-xl border-y border-r border-slate-700/50 cursor-pointer relative flex justify-between items-center"><div><div class="flex items-center gap-2 mb-1"><span class="text-xs font-black ${active ? 'text-white' : 'text-slate-300'}">${r.bil}</span><span class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-slate-800 text-slate-400">${statusTxt}</span></div><div class="text-sm font-bold text-white mb-0.5">${formalText}</div><div class="text-xs text-slate-400 font-mono">${fmtDD(r.start_tid)} ${fmtT(r.start_tid)} - ${fmtT(r.slutt_tid)}</div>${!mineOnly ? `<div class="text-[10px] text-slate-500 mt-1 uppercase font-bold">${r.bid}</div>` : ''}</div><div class="flex flex-col items-end gap-2"><span class="material-icons-round text-slate-600 mb-1">${icon}</span>${actionBtns}</div></div>`;
    });
    html += `</div>`; c.innerHTML = html;
}

function expressBook() { closeM('m-action', false); setExpDur(1); $id('exp-conf-form').value = ""; openM('m-express-list'); }
function setExpDur(hours) { 
    s.expDur = hours; 
    $id('exp-slider').value = hours;
    $id('exp-slider-val').innerText = `${hours} time${hours > 1 ? 'r' : ''}`;
    handleExpSlider(hours);
    renderExpressList(); 
}

function handleExpSlider(val) {
    const hours = parseInt(val);
    s.expDur = hours;
    $id('exp-slider-val').innerText = `${hours} time${hours > 1 ? 'r' : ''}`;
    const baseTime = new Date();
    baseTime.setSeconds(0,0);
    const endTime = new Date(baseTime.getTime() + hours * 3600000);
    $id('exp-end-time').innerText = fmtT(endTime);
    renderExpressList();
}

function renderExpressList() {
    const list = $id('express-options'); list.innerHTML = "<div class='text-center text-slate-500 mt-4'>Laster...</div>";
    const now = new Date(); now.setSeconds(0, 0); 
    let endTime;
    if(s.expDur === 0) { endTime = new Date(now); endTime.setHours(16, 0, 0, 0); if (endTime <= now) endTime.setHours(23, 59, 0, 0); } 
    else endTime = new Date(now.getTime() + s.expDur * 3600000);
    
    const availableCars = s.c.filter(b => {
        if(b.status !== 'Aktiv' || s.h.includes(b.bil)) return false;
        return !s.r.some(r => { const rStart = new Date(r.start_tid); const rEnd = new Date(r.slutt_tid); return r.bil === b.bil && now < rEnd && endTime > rStart; });
    }).sort((a,b) => {
        const catOrder = { 'Uniformert': 1, 'Sivil': 2, 'Admin': 3 };
        const pA = catOrder[a.kategori] || 4; const pB = catOrder[b.kategori] || 4;
        if (pA !== pB) return pA - pB;
        return a.bil.localeCompare(b.bil);
    });
    list.innerHTML = "";
    if(availableCars.length === 0) { list.innerHTML = "<div class='text-center text-red-400 py-4 font-bold'>Ingen ledige biler.</div>"; return; }
    availableCars.forEach(b => {
        const btn = document.createElement('button');
        btn.className = "w-full bg-slate-800 p-4 rounded-xl border border-slate-600 text-left font-bold text-white hover:bg-slate-700 flex justify-between items-center mb-2 shadow-lg overflow-hidden";
        btn.innerHTML = `<div class="flex items-center gap-2 overflow-hidden flex-1 min-w-0"><span class="text-lg flex-shrink-0">${b.bil}</span><div class="flex items-center gap-1 overflow-hidden">${getBadgesHtml(b, true, true, true)}</div></div><span class="text-emerald-400 text-xs bg-emerald-900/30 px-2 py-1 rounded flex-shrink-0 ml-2">LEDIG</span>`;
        btn.onclick = () => initExpressConfirm(b.bil, now, endTime);
        list.appendChild(btn);
    });
}

function initExpressConfirm(car, start, end) {
    s.expCar = car; s.expStart = start; s.expEnd = end;
    const b = s.c.find(x => x.bil === car);
    let extra = "";
    if(b) extra = `<br><span class="text-slate-500 font-normal text-[10px]">${b.kategori||''} ${b.ansvarlig ? '‚Ä¢ '+b.ansvarlig : ''}</span>`;
    $id('exp-conf-txt').innerHTML = `Du velger ${car} ${extra}<br>for perioden N√Ö - ${fmtT(end)}`;
    $id('m-express-list').classList.add('hidden');
    openM('m-express-conf');
}

async function confirmExpress() {
    const formal = $id('exp-conf-form').value;
    if(!formal) return showToast("Skriv form√•l", "error");
    s.bid = s.u.split('@')[0].toUpperCase();
    const d = { bid: s.bid, formal: formal, start_tid: s.expStart.toISOString(), slutt_tid: s.expEnd.toISOString(), bil: s.expCar };
    const { error } = await _s.from('bookinger').insert([d]);
    if(error) showToast("Feil: " + error.message, "error");
    else { showToast("Bestilt!", "success"); closeM('m-express-conf'); load(); }
}

function book(car, id=null, st=null, en=null) { 
    s.sel=[car]; 
    s.editId=id; 
    s.co=s.c.find(x=>x.bil===car); 
    s.workshopMode = false;
    const now = new Date(); now.setHours(0,0,0,0);
    s.tlDay = 0; 
    
    // Clear fields
    $id('b-bid').value=s.bid; 
    $id('b-form').value = "";
    $id('b-extra').value = "";
    
    // Populate if editing
    if(id) {
        const r = s.r.find(x=>x.id===id); 
        $id('b-bid').value=r.bid; 
        
        if(r.formal && r.formal.startsWith('Verksted: ')) { 
            handleFormChange(true); // Toggle verksted mode
            $id('b-verksted-desc').value = r.formal.substring(10); 
        } else {
            handleFormChange(false); // Ensure standard mode
            // Attempt to split category and extra info
            const knownCats = ["M√∏te", "IP", "Oppdrag"];
            let found = false;
            if(r.formal) {
                for(let cat of knownCats) {
                    if(r.formal === cat || r.formal.startsWith(cat + ": ")) {
                        $id('b-form').value = cat;
                        if(r.formal.length > cat.length + 2) {
                            $id('b-extra').value = r.formal.substring(cat.length + 2);
                        }
                        found = true;
                        break;
                    }
                }
            }
            if(!found) {
                $id('b-form').value = "Annet";
                $id('b-extra').value = r.formal || "";
            }
            handleFormChange(); // Refresh UI for extra field
        }

        const stD = new Date(r.start_tid); const enD = new Date(r.slutt_tid);
        setVal('b', 'st', stD); setVal('b', 'en', enD);
        const stDateOnly = new Date(stD); stDateOnly.setHours(0,0,0,0);
        s.tlDay = Math.round((stDateOnly - now) / 86400000); s.tlClick = 2; setupModal(car, 'Rediger');
    } else {
        // New booking
        handleFormChange(false);
        $id('b-form').value = ""; 
        if(st && en) {
            const stD = new Date(st); setVal('b', 'st', stD); setVal('b', 'en', new Date(en)); s.tlClick = 2;
            const stDateOnly = new Date(stD); stDateOnly.setHours(0,0,0,0);
            s.tlDay = Math.round((stDateOnly - now) / 86400000);
        } else { setVal('b', 'st', null); setVal('b', 'en', null); s.tlClick = 0; }
        setupModal(car, 'Ny reservasjon');
    }
}

function handleFormChange(forceVerksted = false) {
    const verk = $id('b-form-verksted');
    const extra = $id('d-extra');
    const bForm = $id('b-form');
    
    if (forceVerksted || bForm.value === 'Verksted') {
        s.workshopMode = true;
        bForm.value = 'Verksted'; // Ensure select is updated if called via toggle
        verk.classList.remove('hidden'); verk.classList.add('flex');
        extra.classList.add('hidden');
    } else {
        s.workshopMode = false;
        verk.classList.add('hidden'); verk.classList.remove('flex');
        
        // Show Extra Input based on selection
        if(bForm.value) {
            extra.classList.remove('hidden');
            const lbl = $id('l-extra');
            const inp = $id('b-extra');
            if(bForm.value === 'Annet') {
                lbl.innerText = "BESKRIVELSE (P√ÖKREVD)";
                inp.placeholder = "Hva gjelder det?";
            } else {
                lbl.innerText = "TILLEGGSINFO (VALGFRITT)";
                inp.placeholder = "F.eks. Sted, sak nr...";
            }
        } else {
            extra.classList.add('hidden');
        }
        $id('b-verksted-desc').value = "";
    }
}

// Removed old toggleVerkstedMode function as it is replaced by handleFormChange

function setupModal(title, sub="Ny reservasjon") {
    const carObj = s.c.find(x => x.bil === title);
    let html = `<span class="truncate">${title}</span>`; 
    if (carObj) { html += `<div class="flex items-center gap-1 ml-2 flex-shrink-0">` + getBadgesHtml(carObj) + `</div>`; }
    $id('b-title').innerHTML = html;
    const subEl = $id('b-sub'); if(subEl) subEl.innerText=sub;
    const act=s.r.find(r=>r.bil===title && new Date(r.start_tid)<=new Date() && new Date(r.slutt_tid)>=new Date());
    $id('b-alert').classList.add('hidden'); $id('b-info').classList.add('hidden'); $id('btn-react').classList.add('hidden');
    const btnOk = $id('btn-ok'); btnOk.disabled = false; btnOk.classList.remove('opacity-50', 'cursor-not-allowed'); btnOk.innerText = "BEKREFT";
    const dateInputs = document.querySelector('#m-book .flex-col.gap-3.mb-4.bg-slate-800');
    if(dateInputs) dateInputs.classList.remove('hidden');

    if(s.co && s.co.kommentar && s.co.status==='Aktiv') { $id('b-info').innerText="INFO: "+s.co.kommentar; $id('b-info').classList.remove('hidden'); }
    if(s.co && s.co.status!=='Aktiv') { 
        $id('b-alert').classList.remove('hidden'); $id('b-reason').innerText="√Örsak: "+(s.co.kommentar||s.co.status); $id('btn-react').classList.remove('hidden'); 
        btnOk.disabled = true; btnOk.classList.add('opacity-50', 'cursor-not-allowed'); btnOk.innerText = "IKKE TILGJENGELIG";
        if(dateInputs) dateInputs.classList.add('hidden');
    }
    
    // Warn if not my booking
    $id('b-owner-warn').classList.add('hidden');
    if(s.editId) {
        const booking = s.r.find(r => r.id === s.editId);
        if(booking && booking.bid !== s.bid) {
            $id('b-owner-warn').classList.remove('hidden');
            $id('b-owner-name').innerText = booking.bid;
        }
    }
    
    if(!s.editId) { 
        $id('btn-del').classList.add('hidden'); const mc = $id('b-multi'); mc.innerHTML = "";
        s.c.forEach(b => { if(b.bil === title || b.status !== 'Aktiv' || s.h.includes(b.bil)) return; mc.innerHTML += `<button onclick="togMulti(this,'${b.bil}')" class="car-pill px-3 py-1 rounded-full text-xs font-bold bg-slate-900">${b.bil}</button>`; });
    } else { $id('btn-del').classList.remove('hidden'); $id('b-multi').innerHTML=""; }

    openM('m-book'); 
    renderTimeline(title, 'book'); 
    setTimeout(() => scrollToView('book'), 50); 
    check(); 
    rFut(title); 
    const instr = $id('b-instr'); if(instr) { if(s.tlClick === 0) instr.innerText = "Trykk starttid (A)"; else if(s.tlClick === 1) instr.innerText = "Velg SLUTTID (B)"; else instr.innerText = ""; }
}

function scrollToView(mode) {
    const el = $id(mode === 'search' ? 'ts-search' : 'ts-book'); if(!el) return;
    let slotIndex = 0; 
    if (s.tlDay === 0) {
        const now = new Date();
        const currentSlot = now.getHours() * 2 + (now.getMinutes() >= 30 ? 1 : 0);
        slotIndex = Math.max(0, currentSlot - 1);
    } else {
        slotIndex = (s.tlDay * 48) + 12;
    }
    const firstBlock = el.querySelector('.time-block'); 
    if(firstBlock) { const width = firstBlock.offsetWidth + 2; el.scrollLeft = slotIndex * width; }
}

function handleTimelineScroll(mode) {
    const el = $id(mode === 'search' ? 'ts-search' : 'ts-book');
    const disp = $id(mode === 'search' ? 's-tl-date-disp' : 'b-tl-date-disp');
    if(!el || !disp) return;
    const dayWidth = 44 * 48; const scrollX = el.scrollLeft; const dayIndex = Math.floor((scrollX + 100) / dayWidth); 
    const d = new Date(); d.setDate(d.getDate() + dayIndex);
    const today = new Date(); let text = fmtDD(d);
    if(d.toDateString() === today.toDateString()) text = "I DAG";
    else { const tom = new Date(); tom.setDate(today.getDate() + 1); if(d.toDateString() === tom.toDateString()) text = "I MORGEN"; }
    disp.innerText = text;
}

function togMulti(el, c) { el.classList.toggle('selected'); if(s.sel.includes(c)) s.sel = s.sel.filter(x => x !== c); else s.sel.push(c); check(); }

function renderTimeline(car, mode) {
    const prefix = mode === 'search' ? 's' : 'b'; 
    const el = $id(mode === 'search' ? 'timeline-search' : 'timeline'); 
    if(!el) return;
    el.innerHTML = "";
    
    const now = new Date(); const daysToRender = 14; const totalSlots = daysToRender * 48;
    const startOfAll = new Date(); startOfAll.setHours(0,0,0,0);
    const selSt = getVal(prefix, 'st'); const selEn = getVal(prefix, 'en');
    for (let i = 0; i < totalSlots; i++) { 
        const slot = document.createElement('div'); slot.className = 'time-block';
        const slotTime = new Date(startOfAll.getTime() + i * 1800000); const h = slotTime.getHours();
        if (i % 2 === 0) { const lbl = document.createElement('div'); lbl.className = 'time-label'; lbl.innerText = h.toString().padStart(2,'0'); slot.appendChild(lbl); }
        if (i > 0 && i % 48 === 0) { slot.style.borderLeft = "3px dashed #94a3b8"; }
        let busy = false;
        if(mode === 'book' && car) { s.r.forEach(r => { if(r.bil === car && r.id != s.editId) { const rSt = new Date(r.start_tid); const rEn = new Date(r.slutt_tid); const slotEnd = new Date(slotTime.getTime() + 1800000); if (rSt < slotEnd && rEn > slotTime) busy = true; } }); }
        const slotEnd = new Date(slotTime.getTime() + 1800000);
        if (slotEnd < now) slot.classList.add('past');
        if (busy) slot.classList.add('busy');
        if (selSt && selEn && selSt < selEn) { if (Math.abs(selSt - slotTime) < 1000) slot.classList.add('start'); else if (Math.abs(selEn - slotEnd) < 1000) slot.classList.add('end'); else if (slotTime > selSt && slotEnd < selEn) slot.classList.add('range'); } 
        else if (selSt && Math.abs(selSt - slotTime) < 1000) slot.classList.add('start'); 
        slot.onclick = (e) => { e.stopPropagation(); handleBlockClick(slotTime, mode); };
        el.appendChild(slot);
    }

    // Add current time indicator line (AFTER blocks to be on top)
    const diffMs = now - startOfAll;
    if(diffMs >= 0 && diffMs < (daysToRender * 24 * 60 * 60 * 1000)) {
        const diffMins = diffMs / 60000;
        const slots = Math.floor(diffMins / 30);
        const rem = diffMins % 30;
        // 4px padding + slots * (42+2) + fraction of 42
        const left = 4 + (slots * 44) + ((rem/30)*42);
        const line = document.createElement('div');
        line.className = 'time-now-line';
        line.style.left = `${left}px`;
        el.appendChild(line);
    }
}

function handleBlockClick(time, mode) {
    const prefix = mode === 'search' ? 's' : 'b'; const now = new Date(); 
    
    // Logic update: Allow current slot
    const currentSlotStart = new Date(now);
    currentSlotStart.setSeconds(0,0);
    currentSlotStart.setMinutes(Math.floor(currentSlotStart.getMinutes()/30)*30);

    if(time < currentSlotStart) { 
        time = currentSlotStart; 
    }

    if (s.tlClick === 2) s.tlClick = 0;
    if (s.tlClick === 0) { setVal(prefix, 'st', time); setVal(prefix, 'en', time); s.tlClick = 1; } 
    else { const stTime = getVal(prefix, 'st'); if (time <= stTime) { setVal(prefix, 'st', time); setVal(prefix, 'en', time); } else { const endTime = new Date(time.getTime() + 1800000); setVal(prefix, 'en', endTime); s.tlClick = 2; } }
    if (mode === 'search') synS(null); renderTimeline(s.co ? s.co.bil : null, mode); if (mode === 'book') check(null);
}

function synS(src) { if (src === 'start') { const st = $id('s-d-st').value; if (st) $id('s-d-en').value = st; } check(); }

function check(src) {
    let prefix = 'b'; let mode = 'book';
    if(s.activeModal === 'm-search' || !$id('m-search').classList.contains('hidden')) { prefix = 's'; mode = 'search'; }
    if (src === 'start') { const stVal = $id(`${prefix}-d-st`).value; if (stVal) $id(`${prefix}-d-en`).value = stVal; }
    
    const stInput = $id(prefix+'-d-st').value;
    if(stInput) {
        const parts = stInput.split('-'); const d = new Date(parts[0], parts[1]-1, parts[2]); 
        const n = new Date(); n.setHours(0,0,0,0); const diff = Math.round((d - n) / 86400000);
        if(diff >= 0 && diff !== s.tlDay) { s.tlDay = diff; scrollToView(mode); }
    }

    const stDate = getVal(prefix, 'st'); const enDate = getVal(prefix, 'en');
    
    // Only re-render timeline if car exists (prevents clearing on load)
    if(mode === 'book' && s.co) renderTimeline(s.co.bil, 'book');
    
    const instr = $id(mode === 'search' ? 's-instr' : 'b-instr'); if(instr) { if(s.tlClick === 0) instr.innerText = "Trykk starttid (A)"; else if(s.tlClick === 1) instr.innerText = "Velg SLUTTID (B)"; else instr.innerText = ""; }
    
    // NEW LOGIC: Use stDate and enDate to check for collision OR if empty check 'now'
    let collision = null;
    if(stDate && enDate) {
        collision = s.sel.some(c => s.r.some(r => r.id != s.editId && r.bil===c && new Date(r.start_tid) < enDate && new Date(r.slutt_tid) > stDate)) ? 
                    s.r.find(r => r.id != s.editId && s.sel.includes(r.bil) && new Date(r.start_tid) < enDate && new Date(r.slutt_tid) > stDate) : null;
    } else {
        // Fallback check if no dates selected yet (implies 'now')
        const now = new Date();
        collision = s.sel.some(c => s.r.some(r => r.id != s.editId && r.bil===c && new Date(r.start_tid) <= now && new Date(r.slutt_tid) >= now)) ?
                    s.r.find(r => r.id != s.editId && s.sel.includes(r.bil) && new Date(r.start_tid) <= now && new Date(r.slutt_tid) >= now) : null;
    }

    const btn = $id('btn-ok'); 
    
    if(btn) {
        if(collision) {
             // Show Alert because of collision
             $id('b-alert').classList.remove('hidden');
             $id('al-t').innerHTML = '<span class="material-icons-round">error</span> OPPTATT';
             $id('b-reason').innerText = `Opptatt av ${collision.bid} (${fmtT(collision.start_tid)} - ${fmtT(collision.slutt_tid)})`;
             btn.disabled = true; 
             btn.classList.add('opacity-50'); 
        } 
        else if (!stDate || !enDate) {
             // Invalid dates, but no collision (e.g. just empty)
             // Hide alert unless car status is bad
             if(s.co && s.co.status === 'Aktiv') $id('b-alert').classList.add('hidden');
             btn.disabled = true; 
             btn.classList.add('opacity-50');
        }
        else { 
             // Valid dates, no collision
             if(s.co && s.co.status !== 'Aktiv') { 
                 // Car is broken/garage, keep alert from setupModal
                 btn.disabled = true; btn.classList.add('opacity-50'); 
             } else { 
                 $id('b-alert').classList.add('hidden'); // HIDE ALERT
                 $id('warn').classList.add('hidden'); 
                 btn.disabled = false; 
                 btn.classList.remove('opacity-50'); 
             } 
        }
    }
}

function getVal(p, type) { const d = $id(`${p}-d-${type}`).value; const t = $id(`${p}-t-${type}`).value; if(!d || !t) return null; return new Date(d + 'T' + t); }
function setVal(p, type, date) { if(!date) { $id(`${p}-d-${type}`).value = ""; $id(`${p}-t-${type}`).value = ""; return; } const iso = isoLocal(date); $id(`${p}-d-${type}`).value = iso.slice(0,10); $id(`${p}-t-${type}`).value = iso.slice(11,16); }
function isoLocal(d) { const z = d.getTime() - (d.getTimezoneOffset() * 60000); return new Date(z).toISOString().slice(0,16); }
async function logMsg(type, innhold, bil) { const { error } = await _s.from('meldinger').insert([{type: type, innhold: innhold, bil: bil, bruker: s.bid}]); if(error) console.error("Kunne ikke lagre melding", error); }

async function confB() {
    if(s.co && s.co.status !== 'Aktiv') return showToast("Bilen er utilgjengelig", "error");
    const b=$id('b-bid').value.trim().toUpperCase();
    
    let f="";
    if(s.workshopMode) {
        const desc = $id('b-verksted-desc').value.trim();
        if(!desc) return showToast("Skriv hva som skal gj√∏res", "error");
        f = "Verksted: " + desc;
    } else {
        const cat = $id('b-form').value;
        const extra = $id('b-extra').value.trim();
        
        if(!cat) return showToast("Velg oppdragstype", "error");
        if(cat === 'Annet' && !extra) return showToast("Skriv beskrivelse", "error");
        
        f = cat + (extra ? ": " + extra : "");
    }

    const st = getVal('b', 'st');
    const en = getVal('b', 'en');

    if(!b) return showToast("Mangler BID", "error"); 
    if(!f) return showToast("Mangler form√•l", "error"); 
    if(!s.sel.length) return showToast("Velg bil", "error"); 
    if(!st || !en) return showToast("Velg tid", "error");
    if(en <= st) return showToast("Ugyldig tid", "error");
    
    if(s.workshopMode) logMsg('Planlagt verksted', f, s.sel[0]);
    else localStorage.setItem('lastFormal', f);

    const d = { bid:b, formal:f, start_tid:st.toISOString(), slutt_tid:en.toISOString() };
    let error;
    if(s.editId) { const { error: err } = await _s.from('bookinger').update(d).eq('id',s.editId); error = err; } 
    else { const { error: err } = await _s.from('bookinger').insert(s.sel.map(c=>({...d,bil:c}))); error = err; }

    if(error) showToast("Feil: " + error.message, "error");
    else { showToast("Lagret!", "success"); closeM('m-book'); load(); }
}

async function delB(id) { 
    const delId = id || s.editId;
    const r = s.r.find(x => x.id === delId);
    if(!r) return;
    
    // NEW SECURITY CHECK: If it's not my booking, ask for extra confirmation
    if (r.bid !== s.bid) {
        if(!confirm(`ADVARSEL: Denne reservasjonen tilh√∏rer ${r.bid}. Er du helt sikker p√• at du vil slette den?`)) return;
    }

    const txt = `Vil du slette reservasjon for ${r.bil}?\n\nTid: ${fmtDD(r.start_tid)} kl. ${fmtT(r.start_tid)} - ${fmtT(r.slutt_tid)}\nForm√•l: ${r.formal}`;
    if(confirm(txt)) { await _s.from('bookinger').delete().eq('id', delId); if(s.editId && s.activeModal === 'm-book') closeM('m-book'); load(); showToast("Slettet", "info"); } 
}

function rFut(c) {
    const l=$id('fut-l'); l.innerHTML="";
    const now=new Date();
    const f=s.r.filter(r=>r.bil===c && new Date(r.start_tid)>now).sort((a,b)=>new Date(a.start_tid)-new Date(b.start_tid));
    if(!f.length) l.innerHTML="<div class='text-slate-500 italic text-center'>Ingen kommende turer.</div>";
    f.forEach(r => {
        const div = document.createElement('div');
        div.className = "bg-slate-800 p-3 rounded-lg border border-slate-700 flex justify-between items-center cursor-pointer mb-2 hover:bg-slate-700 transition-colors";
        div.innerHTML = `
            <div class="flex flex-col">
                <span class="text-xs text-white font-bold">${fmtDD(r.start_tid)}</span>
                <span class="text-[10px] text-slate-400 font-mono">${fmtT(r.start_tid)} - ${fmtT(r.slutt_tid)}</span>
                <span class="text-[10px] text-slate-500 italic mt-1">${r.formal} (${r.bid})</span>
            </div>
            <div class="flex items-center gap-3">
                <span class="material-icons-round text-blue-400 text-sm bg-blue-900/30 p-1 rounded-full">edit</span>
            </div>`;
        div.onclick = (e) => { e.stopPropagation(); s.workshopMode = (r.formal || "").startsWith('Verksted: '); book(r.bil, r.id); };
        l.appendChild(div);
    });
}

function sMode() { 
    s.tlClick = 0; s.tlDay = 0; const now = new Date(); if(now.getHours() >= 22) s.tlDay = 1;
    closeM('m-action', false);
    openM('m-search'); 
    setVal('s', 'st', null);
    setVal('s', 'en', null);
    renderTimeline(null, 'search');
    setTimeout(() => scrollToView('search'), 50); 
}

function findC() {
    const st = getVal('s', 'st');
    const en = getVal('s', 'en');
    if(!st || !en) return showToast("Velg tidsrom", "error");
    const l=$id('s-res'); l.innerHTML=""; l.classList.remove('hidden');
    if(st >= en) return showToast("Velg slutt-tid", "error");

    const cars = s.c.filter(b => b.status==='Aktiv' && !s.h.includes(b.bil));
    
    const available = [];
    const busy = [];

    cars.forEach(b => {
        // Find collision
        const collision = s.r.find(r => r.bil === b.bil && st < new Date(r.slutt_tid) && en > new Date(r.start_tid));
        if (collision) {
            b.collision = collision; // Store for display
            busy.push(b);
        } else {
            available.push(b);
        }
    });

    // Sort functions (reuse existing sort logic)
    const sorter = (a,b) => {
        const catOrder = { 'Uniformert': 1, 'Sivil': 2, 'Admin': 3 };
        const pA = catOrder[a.kategori] || 4;
        const pB = catOrder[b.kategori] || 4;
        if (pA !== pB) return pA - pB;
        return a.bil.localeCompare(b.bil);
    };

    available.sort(sorter);
    busy.sort(sorter);

    if(available.length === 0 && busy.length === 0) { 
        l.innerHTML="<div class='text-center text-red-400'>Ingen biler funnet.</div>"; 
        return; 
    }

    // Render Available
    available.forEach(b => {
        l.innerHTML += `
        <button onclick="found('${b.bil}')" class="w-full bg-slate-800 p-3 rounded-xl flex justify-between border border-emerald-900/50 text-white font-bold mb-2 items-center overflow-hidden shadow-lg">
            <div class="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
                <span class="block flex-shrink-0 text-lg">${b.bil}</span>
                <div class="flex items-center gap-1 overflow-hidden">${getBadgesHtml(b, true, true, true)}</div>
            </div>
            <span class="text-emerald-400 text-xs bg-emerald-900/30 px-2 py-1 rounded flex-shrink-0 ml-2 border border-emerald-900/50">LEDIG</span>
        </button>`;
    });

    // Render Busy (if any)
    if (busy.length > 0) {
        if (available.length > 0) l.innerHTML += `<div class="text-center text-xs text-slate-500 font-bold uppercase my-3 tracking-widest">- Opptatt i tidsrommet -</div>`;
        
        busy.forEach(b => {
            const r = b.collision;
            const timeTxt = `${fmtT(r.start_tid)}-${fmtT(r.slutt_tid)}`;
            l.innerHTML += `
            <button onclick="found('${b.bil}')" class="w-full bg-slate-800/40 p-3 rounded-xl flex justify-between border border-red-900/30 text-slate-300 font-bold mb-2 items-center overflow-hidden opacity-80">
                <div class="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
                    <span class="block flex-shrink-0 text-lg decoration-slate-500 line-through decoration-2">${b.bil}</span>
                    <div class="flex items-center gap-1 overflow-hidden opacity-50">${getBadgesHtml(b, true, true, true)}</div>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-red-400 text-[10px] bg-red-900/20 px-2 py-0.5 rounded border border-red-900/30 mb-0.5">OPPTATT</span>
                    <span class="text-[10px] font-mono text-slate-400">${timeTxt}</span>
                </div>
            </button>`;
        });
    }
}

function found(c) { 
    const st = getVal('s', 'st');
    const en = getVal('s', 'en');
    closeM('m-search', false); 
    book(c, null, st, en); 
}

function ret(id, c, type='standard') { s.rid=id; s.rc=c; s.rtype=type; $id('r-name').innerText=c; $id('r-comm').value=""; openM('m-ret'); }

async function subRet(id, c) {
    if(id && c) { s.rid = id; s.rc = c; }
    const cm=$id('r-comm').value || ""; 
    const d={slutt_tid:new Date().toISOString()}; 
    if(cm) d.kommentar=cm;
    await _s.from('bookinger').update(d).eq('id',s.rid);
    if(cm) { await _s.from('biler').update({kommentar:cm}).eq('bil',s.rc); logMsg('Avvik ved levering', cm, s.rc); }
    closeM('m-ret'); 
    load(); 
    showToast("Levert!", "success");
}

async function react() { if(confirm(`Vil du gj√∏re ${s.co.bil} tilgjengelig igjen?\nN√•v√¶rende status: ${s.co.status}`)) { await _s.from('biler').update({status:'Aktiv',kommentar:null}).eq('id',s.co.id); closeM('m-book'); load(); showToast("Bil aktivert", "success"); } }

function rAdm(c) {
    let html = `<div class="flex flex-wrap gap-2 mb-4 bg-slate-800 p-3 rounded-xl border border-slate-700">`;
    s.c.forEach(b => {
       let colorClass = 'pill-gray'; if (b.status === 'Aktiv') { if (b.kommentar) colorClass = 'pill-yellow'; else colorClass = 'pill-green'; }
       const carJson = JSON.stringify(b).replace(/"/g, '&quot;');
       // FIX: Use ID instead of JSON object to prevent onclick issues
       html += `<button onclick="openAdmEdit({id: '${b.id}'})" class="car-pill ${colorClass} px-3 py-1 rounded-full text-xs font-bold">${b.bil}</button>`;
    });
    
    // SJEKK: Er bruker admin?
    const isAdm = s.bilansvarlig && s.bilansvarlig.toLowerCase().includes(s.u.toLowerCase());
    
    if(isAdm) {
        html += `<button onclick="addC()" class="car-pill px-3 py-1 rounded-full text-xs font-bold bg-blue-900 text-blue-200 border-blue-700">+ NY</button>`;
    } else {
        html += `<button disabled class="car-pill px-3 py-1 rounded-full text-xs font-bold bg-slate-800 text-slate-600 border-slate-700 opacity-50 cursor-not-allowed">+ NY</button>`;
    }
    
    html += `<button onclick="showAdmHelp()" class="car-pill px-3 py-1 rounded-full text-xs font-bold bg-slate-700 text-slate-300 border-slate-500">?</button></div>`;
    html += `<div class="text-center text-slate-500 italic mt-10">Trykk p√• en bil for √• endre</div>`;
    c.innerHTML = html;
}

function openAdmEdit(params) {
    let b = null;
    
    if(params && params.id) {
        // Find car by ID from the global state s.c
        b = s.c.find(car => car.id == params.id);
    }
    
    s.admCar = b ? b.bil : null;
    s.admId = b ? b.id : null; // If null, it's a new car
    
    // Reset or fill form
    $id('adm-title').innerText = b ? "Rediger Bil" : "Ny Bil";
    $id('adm-name').value = b ? b.bil : "";
    $id('adm-resp').value = b && b.ansvarlig ? b.ansvarlig : "";
    $id('adm-cat').value = b && b.kategori ? b.kategori : "Uniformert";
    $id('adm-stat').value = b ? b.status : "Aktiv";
    $id('adm-comm').value = b && b.kommentar ? b.kommentar : "";
    $id('adm-info').value = b && b.intern_info ? b.intern_info : "";

    // Visibility logic for delete button
    const isAdm = s.bilansvarlig && s.bilansvarlig.toLowerCase().includes(s.u.toLowerCase());
    const delBtn = $id('btn-adm-del');
    
    if(isAdm && s.admId) { // Only show delete if user is admin AND it's an existing car
        delBtn.classList.remove('hidden');
    } else {
        delBtn.classList.add('hidden');
    }
    
    // Store old car name for rename logic
    s.oldAdmCarName = s.admCar;

    openM('m-admin-edit');
}

async function saveAdmCar() {
    const name = $id('adm-name').value.toUpperCase();
    const resp = $id('adm-resp').value; 
    const cat = $id('adm-cat').value;
    const stat = $id('adm-stat').value;
    const comm = $id('adm-comm').value;
    const info = $id('adm-info').value;
    
    if(!name) return showToast("Mangler navn", "error");

    const data = { bil: name, ansvarlig: resp, kategori: cat, status: stat, kommentar: comm, intern_info: info };

    let error;
    if (s.admId) {
        // UPDATE existing - FIRST update bookings, THEN car
        if (s.oldAdmCarName && s.oldAdmCarName !== name) {
             const { error: bookingErr } = await _s.from('bookinger').update({ bil: name }).eq('bil', s.oldAdmCarName);
             if (bookingErr) console.error("Feil ved oppdatering av bookinger:", bookingErr);
             else console.log(`Oppdaterte bookinger fra ${s.oldAdmCarName} til ${name}`);
        }

        const { error: err } = await _s.from('biler').update(data).eq('id', s.admId);
        error = err;
        
        if(!err) {
             if(stat !== 'Aktiv') logMsg('Statusendring', `Ny status: ${stat}`, name);
             if(comm) logMsg('Ny kommentar', comm, name);
        }
    } else {
        // INSERT new
        const { error: err } = await _s.from('biler').insert([data]);
        error = err;
        if(!err) logMsg('Ny bil opprettet', 'Lagt til i systemet', name);
    }
    
    if(error) {
        showToast("Feil: " + error.message, "error");
    } else {
        showToast("Lagret!", "success");
        closeM('m-admin-edit');
        load(); // Reload full list to show new car
    }
}

async function updateInternalNote(id, val) { const { error } = await _s.from('biler').update({ intern_info: val }).eq('id', id); if(error) showToast("Feil ved lagring", "error"); else showToast("Intern info lagret", "success"); }
function showAdmHelp() { showToast("Gr√∏nn: OK. Gul: Har kommentar. Gr√•: Ute av drift.", "info"); }
function addC() { openAdmEdit(null); } // Modified to use modal
async function delC(id,n) { if(confirm("Slette?")) { await _s.from('bookinger').delete().eq('bil',n); await _s.from('biler').delete().eq('id',id); s.admCar=null; closeM('m-admin-edit'); load(); showToast("Slettet", "info"); } }

function rLog(c) {
    if(!s.fullLog) {
        c.innerHTML = "<div class='text-center text-slate-500 mt-10'>Henter historikk...</div>";
        return;
    }
    const l = s.fullLog; 
    c.innerHTML = `<button onclick="csv()" class="w-full bg-blue-900/50 text-blue-300 py-3 rounded-xl text-xs font-bold border border-blue-800 mb-4 shadow-lg flex items-center justify-center gap-2"><span class="material-icons-round text-sm">download</span> LAST NED CSV (HISTORIKK)</button><div class="space-y-3">` + l.map(h => {
        const dateOpt = { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' }; const dateStr = new Date(h.start_tid).toLocaleDateString('no-NO', dateOpt);
        return `<div class="bg-slate-800 p-4 rounded-xl border border-slate-700 text-sm"><div class="flex justify-between font-bold text-white mb-1"><span>${h.bil}</span><span class="text-slate-400">${h.bid}</span></div><div class="text-slate-400 text-xs mb-1 capitalize">${dateStr} | ${fmtT(h.start_tid)}-${fmtT(h.slutt_tid)}</div><div class="text-slate-300 italic">"${h.formal}"</div>${h.kommentar?`<div class="mt-1 text-amber-400 bg-amber-900/20 px-2 py-1 rounded inline-block text-xs">${h.kommentar}</div>`:''}</div>`;
    }).join('') + `</div>`;
}

async function csv() { 
    if(!s.fullLog) {
        showToast("Laster data...", "info");
        await loadFullHistory();
    }
    const t = "Bil,Bruker,Start,Slutt,Form√•l,Merknad\n" + s.fullLog.map(x => `${x.bil},${x.bid},${fmtD(x.start_tid)} ${fmtT(x.start_tid)},${fmtD(x.slutt_tid)} ${fmtT(x.slutt_tid)},"${x.formal}",${x.kommentar||''}`).join('\n'); 
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([t], { type: 'text/csv;charset=utf-8;' })); a.download = "logg.csv"; a.click(); 
}

function rSet(c) {
    let p = s.c.map(b => `<button onclick="tVis('${b.bil}')" class="px-3 py-2 rounded-lg text-xs font-bold border transition-colors ${s.h.includes(b.bil)?'bg-slate-800 text-slate-500 border-slate-700 opacity-50':'bg-blue-600 text-white border-blue-500 shadow-md'}">${b.bil}</button>`).join('');
    
    c.innerHTML = `
    <!-- Card 1: Min Profil -->
    <div class="settings-card">
        <div class="settings-header"><span class="material-icons-round text-blue-500">person</span> Min Profil</div>
        <div class="flex flex-col gap-1">
             <label class="text-[10px] text-slate-500 font-bold uppercase">Innlogget som</label>
             <p class="text-xl font-black text-white tracking-tight">${s.bid}</p>
             <p class="text-xs text-slate-500 font-mono">${s.u}</p>
        </div>
    </div>

    <!-- Card 2: Visning -->
    <div class="settings-card">
        <div class="settings-header"><span class="material-icons-round text-purple-500">visibility</span> Visningsvalg</div>
        
        <div class="space-y-4">
            <div class="flex items-center justify-between border-b border-slate-700/50 pb-3">
                <div class="flex flex-col">
                    <span class="text-sm text-slate-200 font-medium">St√∏rre tekst og knapper</span>
                    <p class="text-[10px] text-slate-500 mt-1 leading-tight">√òker st√∏rrelsen p√• elementer for bedre lesbarhet p√• mobil.</p>
                </div>
                <input type="checkbox" onchange="togUiSize(this.checked)" ${s.uiLarge?'checked':''} class="w-6 h-6 accent-blue-600 rounded cursor-pointer shrink-0">
            </div>
             <div class="flex items-center justify-between border-b border-slate-700/50 pb-3">
                <div class="flex flex-col">
                    <span class="text-sm text-slate-200 font-medium">Vis biltyper (Piller)</span>
                    <p class="text-[10px] text-slate-500 mt-1 leading-tight">Viser type bil (Uniformert/Sivil) som merker i oversikten.</p>
                </div>
                <input type="checkbox" onchange="togVis('visType', this.checked)" ${s.visType?'checked':''} class="w-6 h-6 accent-blue-600 rounded cursor-pointer shrink-0">
            </div>
             <div class="flex items-center justify-between">
                <div class="flex flex-col">
                    <span class="text-sm text-slate-200 font-medium">Vis bilansvarlig</span>
                    <p class="text-[10px] text-slate-500 mt-1 leading-tight">Viser hvem som er ansvarlig for hver bil i listen.</p>
                </div>
                <input type="checkbox" onchange="togVis('visResp', this.checked)" ${s.visResp?'checked':''} class="w-6 h-6 accent-blue-600 rounded cursor-pointer shrink-0">
            </div>
            
            <div class="pt-2">
                <p class="text-[10px] text-slate-500 font-bold uppercase mb-3">Velg biler som skal vises</p>
                <div class="flex flex-wrap gap-2">
                    ${p}
                </div>
            </div>
        </div>
    </div>

    <!-- Card 3: Varsling -->
    <div class="settings-card">
        <div class="settings-header"><span class="material-icons-round text-amber-500">notifications</span> Varsling</div>
        <div class="flex items-center justify-between mb-4">
            <span class="text-sm text-slate-200 font-medium">Aktiver e-postvarsel</span>
            <input type="checkbox" onchange="togVar(this.checked)" ${s.varsel ? 'checked' : ''} class="w-6 h-6 accent-amber-600 rounded cursor-pointer">
        </div>
        <div class="flex gap-2">
            <input id="s-em" placeholder="din.epost@gmail.com" value="${s.savedEmail || ''}" class="flex-grow p-3 rounded-xl text-sm bg-slate-900 border border-slate-700 text-white focus:border-amber-500 outline-none transition-colors">
            <button onclick="updEm()" class="bg-amber-600 hover:bg-amber-500 px-4 rounded-xl text-white font-bold text-xs shadow-lg transition-transform active:scale-95">LAGRE</button>
        </div>
        <p class="text-[10px] text-slate-500 mt-2">Motta varsel ca. 30 min f√∏r frist. Bruk gjerne privat e-post.</p>
    </div>

    <!-- Card 4: Info -->
    <div class="settings-card">
        <div class="settings-header"><span class="material-icons-round text-emerald-500">info</span> Hjelp & Info</div>
        <div class="space-y-2">
            <button onclick="window.open('https://bbmanual.pages.dev/')" class="w-full bg-slate-700/50 p-3 rounded-xl font-bold border border-slate-600 text-white flex items-center justify-center gap-2 hover:bg-slate-600 transition-colors">
                <span class="material-icons-round text-sm">auto_stories</span> √Öpne Brukermanual
            </button>
            <button id="pwa-settings-btn" onclick="installPwa()" class="hidden w-full bg-blue-900/30 text-blue-300 p-3 rounded-xl font-bold border border-blue-800 flex items-center justify-center gap-2">
                <span class="material-icons-round text-sm">download</span> Installer som App
            </button>
            <a href="mailto:glenn.andre.hansen@gmail.com" class="w-full bg-slate-700/50 p-3 rounded-xl font-bold border border-slate-600 text-white flex items-center justify-center gap-2 hover:bg-slate-600 transition-colors text-sm no-underline">
                <span class="material-icons-round text-sm">mail</span> Melde feil
            </a>
        </div>
    </div>
    
    <!-- Admin Section -->
    <div class="bg-slate-900/50 p-5 rounded-2xl border border-slate-800">
        <h2 class="text-sm font-bold text-slate-400 mb-4 flex items-center gap-2"><span class="material-icons-round text-slate-500">admin_panel_settings</span> Administrasjon</h2>
        <div class="mb-6">
            <p class="text-[10px] text-slate-500 mb-2 font-bold uppercase">Bilansvarlige (Mottar varsler)</p>
            <div id="admin-email-list" class="flex flex-wrap gap-2 mb-3"></div>
            <div class="flex gap-2">
                <input id="s-admin-new-em" placeholder="ny@admin.no" class="flex-grow p-3 rounded-xl text-sm bg-slate-900 border border-slate-700 text-white outline-none focus:border-blue-500">
                <button onclick="addAdminEmail()" class="bg-slate-700 border border-slate-600 px-4 rounded-xl text-white font-bold text-xs hover:bg-slate-600">LEGG TIL</button>
            </div>
        </div>
        <details>
            <summary class="text-xs font-bold text-red-900/50 cursor-pointer list-none flex justify-between items-center hover:text-red-500 transition-colors p-2 rounded hover:bg-slate-800">Avansert: Slett data <span class="material-icons-round text-sm">expand_more</span></summary>
            <div class="mt-4 p-4 bg-red-900/10 rounded-xl border border-red-900/30">
                <p class="text-[10px] text-red-400 mb-3">Dette sletter ALLE reservasjoner i databasen. Handlingen kan ikke angres.</p>
                <button onclick="nuke()" class="w-full bg-red-900 text-white p-3 rounded-xl font-bold hover:bg-red-800 border border-red-700 shadow-lg text-xs">SLETT ALLE DATA</button>
            </div>
        </details>
    </div>
    `;
    renderAdminEmails();
    if(s.deferredPrompt) { const setBtn = $id('pwa-settings-btn'); if(setBtn) setBtn.classList.remove('hidden'); const icon = $id('install-icon'); if(icon) icon.classList.remove('hidden'); }
}
function renderAdminEmails() {
    const list = $id('admin-email-list'); if(!list) return; list.innerHTML = "";
    const emails = s.bilansvarlig ? s.bilansvarlig.split(',').map(e => e.trim()).filter(e => e) : [];
    if(emails.length === 0) { list.innerHTML = "<span class='text-xs text-slate-500 italic'>Ingen registrert.</span>"; return; }
    emails.forEach(email => { const pill = document.createElement('div'); pill.className = 'email-pill'; pill.innerHTML = `<span>${email}</span><button onclick="removeAdminEmail('${email}')">√ó</button>`; list.appendChild(pill); });
}
async function addAdminEmail() { const input = $id('s-admin-new-em'); const newEmail = input.value.trim(); if(!newEmail) return; const currentEmails = s.bilansvarlig ? s.bilansvarlig.split(',').map(e => e.trim()).filter(e => e) : []; if(currentEmails.includes(newEmail)) { showToast("Allerede lagt til", "info"); return; } currentEmails.push(newEmail); await saveAdminConfig(currentEmails.join(',')); input.value = ""; }
async function removeAdminEmail(email) { if(!confirm(`Fjerne ${email} som bilansvarlig?`)) return; let currentEmails = s.bilansvarlig ? s.bilansvarlig.split(',').map(e => e.trim()).filter(e => e) : []; currentEmails = currentEmails.filter(e => e !== email); await saveAdminConfig(currentEmails.join(',')); }
async function saveAdminConfig(val) { const { error } = await _s.from('konfigurasjon').upsert({ nokkel: 'bilansvarlig_epost', verdi: val }); if(error) showToast("Feil ved lagring", "error"); else { s.bilansvarlig = val; renderAdminEmails(); showToast("Lagret!", "success"); } }
function tVis(c) { s.h.includes(c) ? s.h=s.h.filter(x=>x!==c) : s.h.push(c); localStorage.setItem('h',JSON.stringify(s.h)); render(); }
function togVis(k, v) { s[k] = v; localStorage.setItem(k, v); render(); if(s.v === 'cars') load(); }
function togUiSize(v) { s.uiLarge = v; localStorage.setItem('uiLarge', v); if(v) document.body.classList.add('ui-large'); else document.body.classList.remove('ui-large'); render(); }
async function togVar(v) { s.varsel = v; const p = { brukernavn: s.bid, varsel: v }; if(s.savedEmail) p.epost = s.savedEmail; await _s.from('brukere').upsert(p, { onConflict: 'brukernavn' }); showToast("Innstilling lagret", "success"); }
async function updEm() { const e = $id('s-em').value.trim(); if(!e) return showToast("Skriv e-post", "error"); const { error } = await _s.from('brukere').upsert({ brukernavn: s.bid, epost: e, varsel: s.varsel }, { onConflict: 'brukernavn' }); if(error) showToast("Feil.", "error"); else { s.savedEmail = e; showToast("Lagret.", "success"); } }
async function nuke() { if(prompt("Skriv NULLSTILL for √• slette alle data")==="NULLSTILL") { await _s.from('bookinger').delete().gt('id', 0); load(); showToast("Nullstilt.", "info"); } }
function fmtT(d) { return new Date(d).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
function fmtD(d) { return new Date(d).toLocaleDateString([],{day:'2-digit',month:'2-digit',year:'2-digit'}); }
function fmtDD(dStr) { 
    const d = new Date(dStr);
    const day = d.toLocaleDateString([], {weekday: 'short'}).replace('.','');
    const date = d.toLocaleDateString([], {day:'2-digit', month:'2-digit'});
    return `${day} ${date}`;
}
setInterval(load,10000);
</script>
</body>
</html>
